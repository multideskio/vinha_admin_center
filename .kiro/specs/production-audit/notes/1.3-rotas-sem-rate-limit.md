# AnÃ¡lise 1.3 â€” Endpoints PÃºblicos sem Rate Limiting

**Data:** AnÃ¡lise realizada como parte da auditoria de produÃ§Ã£o
**Requisito:** 2.4 â€” Endpoints pÃºblicos devem ter Rate Limiter
**Ãšltima atualizaÃ§Ã£o:** CorreÃ§Ãµes P0 e P1 aplicadas

## Resumo

- **Total de rotas pÃºblicas analisadas:** 15 (rotas sem autenticaÃ§Ã£o JWT)
- **Com rate limiting:** 12
- **Sem rate limiting:** 3
- **ğŸ”´ CrÃ­ticos (sem auth E sem rate limit):** 0 âœ…
- **ğŸŸ¡ AtenÃ§Ã£o (sem rate limit, risco de abuso):** 0 âœ…
- **ğŸŸ¢ SugestÃ£o (baixo risco ou proteÃ§Ã£o alternativa):** 3

> **Nota sobre rotas legado do gerente:** As rotas `/v1/gerente/dashboard` e `/v1/gerente/perfil` foram corrigidas na Task 9.2 â€” agora possuem `validateRequest()` com verificaÃ§Ã£o de role `manager`. NÃ£o sÃ£o mais rotas pÃºblicas e foram removidas desta anÃ¡lise. Permanecem sem rate limit, mas como rotas autenticadas o risco Ã© significativamente menor.

---

## Rotas PÃºblicas COM Rate Limiting âœ…

| #   | Rota                                           | Mecanismo                                                        |
| --- | ---------------------------------------------- | ---------------------------------------------------------------- |
| 1   | `src/app/api/auth/forgot-password/route.ts`    | `rateLimit()` via `@/lib/rate-limiter` (preset `forgotPassword`) |
| 2   | `src/app/api/auth/reset-password/route.ts`     | `rateLimit()` via `@/lib/rate-limiter` (preset `resetPassword`)  |
| 3   | `src/app/api/v1/auth/login/route.ts`           | `rateLimit()` via `@/lib/rate-limit` (5 req/60s por IP)          |
| 4   | `src/app/api/v1/auth/register/church/route.ts` | `rateLimit()` via `@/lib/rate-limiter` (preset `register`)       |
| 5   | `src/app/api/v1/auth/register/pastor/route.ts` | `rateLimit()` via `@/lib/rate-limiter` (preset `register`)       |
| 6   | `src/app/api/v1/payment-methods/route.ts`      | `rateLimit()` via `@/lib/rate-limit` (30 req/60s por IP)         |
| 7   | `src/app/api/v1/cron/notifications/route.ts`   | `rateLimit()` via `@/lib/rate-limit` (2 req/60s) + CRON_SECRET   |
| 8   | `src/app/api/auth/verify-token/route.ts`       | `rateLimit()` via `@/lib/rate-limit` (10 req/60s por IP) âœ… NOVO |
| 9   | `src/app/api/v1/cep/route.ts`                  | `rateLimit()` via `@/lib/rate-limit` (30 req/60s por IP) âœ… NOVO |
| 10  | `src/app/api/v1/company/public/route.ts`       | `rateLimit()` via `@/lib/rate-limit` (60 req/60s por IP) âœ… NOVO |
| 11  | `src/app/api/v1/maintenance-check/route.ts`    | `rateLimit()` via `@/lib/rate-limit` (60 req/60s por IP) âœ… NOVO |
| 12  | `src/app/api/evolution/webhook/route.ts`       | `rateLimit()` via `@/lib/rate-limit` (60 req/60s por IP) âœ… NOVO |

> **Nota:** O projeto usa **dois mÃ³dulos** de rate limiting diferentes:
>
> - `@/lib/rate-limiter` â€” rate limiter sÃ­ncrono com presets (forgotPassword, resetPassword, register)
> - `@/lib/rate-limit` â€” rate limiter assÃ­ncrono (baseado em Redis)
>   Isso pode causar confusÃ£o e inconsistÃªncia. Considerar unificar.

---

## âœ… Rotas Corrigidas (anteriormente ğŸ”´ CRÃTICO â€” agora com autenticaÃ§Ã£o JWT)

| #   | Rota                                        |                     Auth                      | Rate Limit | Status                                                                                                                                  |
| --- | ------------------------------------------- | :-------------------------------------------: | :--------: | --------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | `src/app/api/v1/gerente/dashboard/route.ts` |    âœ… `validateRequest()` + role `manager`    |     âŒ     | Corrigido na Task 9.2. NÃ£o Ã© mais rota pÃºblica. Sem rate limit, mas protegida por JWT â€” risco baixo.                                    |
| 2   | `src/app/api/v1/gerente/perfil/route.ts`    | âœ… `validateRequest()` + role `manager` + Zod |     âŒ     | Corrigido nas Tasks 9.2/9.3. NÃ£o Ã© mais rota pÃºblica. Possui validaÃ§Ã£o Zod no PUT. Sem rate limit, mas protegida por JWT â€” risco baixo. |

---

## âœ… Rotas ğŸŸ¡ Corrigidas â€” Rate Limit Adicionado

| #   | Rota                                        | Rate Limit | Limite            | Status                                                                                   |
| --- | ------------------------------------------- | :--------: | ----------------- | ---------------------------------------------------------------------------------------- |
| 1   | `src/app/api/auth/verify-token/route.ts`    |     âœ…     | 10 req/60s por IP | Corrigido â€” protege contra brute-force de tokens e DoS no banco                          |
| 2   | `src/app/api/v1/cep/route.ts`               |     âœ…     | 30 req/60s por IP | Corrigido â€” protege contra uso como proxy aberto para ViaCEP                             |
| 3   | `src/app/api/v1/company/public/route.ts`    |     âœ…     | 60 req/60s por IP | Corrigido â€” protege contra DoS no banco                                                  |
| 4   | `src/app/api/v1/maintenance-check/route.ts` |     âœ…     | 60 req/60s por IP | Corrigido â€” protege contra DoS no banco                                                  |
| 5   | `src/app/api/evolution/webhook/route.ts`    |     âœ…     | 60 req/60s por IP | Corrigido â€” protege contra payloads falsos em massa. JÃ¡ possui validaÃ§Ã£o Zod (Task 9.3). |

---

## ğŸŸ¢ Rotas PÃºblicas SEM Rate Limiting â€” SUGESTÃƒO (nÃ£o corrigidas)

| #   | Rota                                     | Severidade | DescriÃ§Ã£o                                                                                                                                                  | SugestÃ£o                                                                                                                |
| --- | ---------------------------------------- | :--------: | ---------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------- |
| 1   | `src/app/api/health/route.ts`            |     ğŸŸ¢     | Health check simples, nÃ£o faz query ao banco. Risco baixo.                                                                                                 | Considerar rate limit leve (ex: 120 req/min) ou deixar sem â€” health checks sÃ£o tipicamente chamados por load balancers. |
| 2   | `src/app/api/v1/sns/webhook/route.ts`    |     ğŸŸ¢     | Webhook AWS SNS. **Valida assinatura SNS** antes de processar â€” proteÃ§Ã£o forte contra payloads falsos. Rate limit poderia bloquear notificaÃ§Ãµes legÃ­timas. | Baixa prioridade. ValidaÃ§Ã£o de assinatura SNS jÃ¡ protege contra abuso. Rate limit opcional (ex: 100 req/min).           |
| 3   | `src/app/api/v1/webhooks/cielo/route.ts` |     ğŸŸ¢     | Webhook Cielo. NÃ£o valida origem, mas a Cielo retenta webhooks com erro. Rate limit agressivo poderia causar perda de notificaÃ§Ãµes de pagamento.           | Baixa prioridade. Considerar validaÃ§Ã£o de origem (IP whitelist da Cielo) como alternativa.                              |

> **Nota:** O cron job `src/app/api/cron/notifications/route.ts` (sem rate limit) foi removido desta seÃ§Ã£o â€” usa autenticaÃ§Ã£o via `CRON_SECRET` com `timingSafeEqual`, o que jÃ¡ Ã© proteÃ§Ã£o suficiente.

---

## ObservaÃ§Ãµes Importantes

### 1. Dois mÃ³dulos de rate limiting

O projeto possui **dois mÃ³dulos diferentes** de rate limiting:

- `src/lib/rate-limiter.ts` â€” Rate limiter **sÃ­ncrono** (in-memory) com presets configurados
- `src/lib/rate-limit.ts` â€” Rate limiter **assÃ­ncrono** (baseado em Redis)

Isso causa inconsistÃªncia: algumas rotas usam um, outras usam outro. Recomenda-se unificar em um Ãºnico mÃ³dulo.

### 2. Webhook Evolution â€” melhorado mas ainda vulnerÃ¡vel

O webhook da Evolution API (`/api/evolution/webhook`) agora possui **validaÃ§Ã£o Zod** do payload (corrigido na Task 9.3), mas ainda nÃ£o valida a origem das requisiÃ§Ãµes. Diferente do webhook SNS que valida assinatura. Risco de seguranÃ§a independente do rate limiting.

### 3. PriorizaÃ§Ã£o de correÃ§Ãµes restantes

| Prioridade | AÃ§Ã£o                                                                                     | Status                                                        |
| ---------- | ---------------------------------------------------------------------------------------- | ------------------------------------------------------------- |
| ~~ğŸ”´ P0~~  | ~~Corrigir rotas legado do gerente (sem auth + sem rate limit)~~                         | âœ… Corrigido â€” agora com `validateRequest()`                  |
| ~~ğŸŸ¡ P1~~  | ~~Adicionar rate limit em `verify-token`, `cep`, `company/public`, `maintenance-check`~~ | âœ… Corrigido â€” rate limit via Redis adicionado                |
| ~~ğŸŸ¡ P1~~  | ~~Adicionar rate limit no webhook Evolution~~                                            | âœ… Corrigido â€” 60 req/60s por IP                              |
| ğŸŸ¢ P2      | Considerar rate limit nos webhooks Cielo/SNS e health check                              | NÃ£o aplicado â€” risco baixo, proteÃ§Ãµes alternativas existentes |
| ğŸŸ¢ P2      | Unificar mÃ³dulos de rate limiting                                                        | Pendente â€” melhoria de arquitetura                            |
