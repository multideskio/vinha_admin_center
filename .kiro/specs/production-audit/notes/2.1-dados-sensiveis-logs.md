# 2.1 â€” Dados SensÃ­veis Expostos em Logs

**Data:** 2025-01-28
**Requisito:** 2.2 â€” Identificar dados sensÃ­veis (senhas, tokens, chaves API) expostos em logs
**Status:** âœ… Todos os 22 achados corrigidos
**Ãšltima atualizaÃ§Ã£o:** CorreÃ§Ãµes aplicadas

---

## Resumo

O projeto possui um utilitÃ¡rio de sanitizaÃ§Ã£o de logs (`src/lib/log-sanitizer.ts`) com funÃ§Ãµes `safeLog`, `safeError` e `safeWarn` que mascaram CPF, cartÃµes de crÃ©dito, CVV, senhas, tokens e Bearer tokens. TambÃ©m existe um `Logger` estruturado (`src/lib/logger.ts`) com sanitizaÃ§Ã£o prÃ³pria. **PorÃ©m, a maioria do cÃ³digo usa `console.log`/`console.error` diretamente, sem passar pelo sanitizador.**

### EstatÃ­sticas

- **`safeLog`/`safeError` usado:** ~15 ocorrÃªncias (principalmente em `src/lib/cielo.ts` e `src/lib/notifications.ts`)
- **`console.error` direto:** ~50+ ocorrÃªncias em `src/lib/` e `src/app/api/`
- **`console.log` direto:** ~15+ ocorrÃªncias em `src/lib/`, `src/workers/`, `src/db/`
- **`console.warn` direto:** ~10+ ocorrÃªncias
- **`devLog` (dev only):** ~20+ ocorrÃªncias em `src/components/contributions/`

---

## Achados

### ğŸ”´ CRÃTICO

| #   | Arquivo                                                 | Linha | DescriÃ§Ã£o                                                                                                                                                                                                                                      | Impacto                                                           | SugestÃ£o                                                               |
| --- | ------------------------------------------------------- | ----- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------- | ---------------------------------------------------------------------- |
| 1   | `src/components/contributions/hooks/useContribution.ts` | 177   | `devLog('Card payment started:', { holder: cardData.holder, installments })` â€” Loga nome do titular do cartÃ£o. Embora `devLog` sÃ³ execute em dev, o cÃ³digo estÃ¡ em produÃ§Ã£o e a verificaÃ§Ã£o `isDevelopment()` pode falhar em edge cases.       | ExposiÃ§Ã£o de dados PCI (nome do titular) no console do navegador  | Remover logging de dados de cartÃ£o completamente, mesmo em dev         |
| 2   | `src/components/contributions/hooks/useContribution.ts` | 101   | `devLog('Form submission started:', data)` â€” Loga `ContributionData` completo que pode conter dados pessoais do contribuinte                                                                                                                   | ExposiÃ§Ã£o de dados pessoais no console do navegador               | Logar apenas campos nÃ£o-sensÃ­veis (tipo de pagamento, step)            |
| 3   | `src/components/contributions/hooks/usePaymentSync.ts`  | 39    | `devLog('Payment status response:', data)` â€” Loga resposta completa da API de transaÃ§Ãµes que pode conter dados de pagamento                                                                                                                    | ExposiÃ§Ã£o de dados de transaÃ§Ã£o no console do navegador           | Logar apenas o status do pagamento, nÃ£o a resposta completa            |
| 4   | `src/lib/api-error-handler.ts`                          | 18    | `console.error('API Error:', error)` â€” Handler centralizado de erros loga o objeto `error` completo sem sanitizaÃ§Ã£o. Erros podem conter dados de request body, tokens, ou contexto sensÃ­vel                                                    | ExposiÃ§Ã£o de dados sensÃ­veis em logs de servidor via stack traces | Usar `safeError` do `log-sanitizer.ts`                                 |
| 5   | `src/lib/api-auth.ts`                                   | 42    | `console.error('API Key authentication error:', error)` â€” Loga erro de autenticaÃ§Ã£o de API Key sem sanitizaÃ§Ã£o. O objeto error pode conter a chave API no contexto                                                                             | PossÃ­vel exposiÃ§Ã£o de API Keys em logs                            | Usar `safeError` e logar apenas `error.message`                        |
| 6   | `src/lib/cielo-logger.ts`                               | 17-18 | `requestBody: data.requestBody ? JSON.stringify(data.requestBody) : null` â€” Armazena request body completo da Cielo no banco de dados sem sanitizaÃ§Ã£o. Para pagamentos com cartÃ£o, isso pode incluir nÃºmero do cartÃ£o, CVV e data de expiraÃ§Ã£o | Dados PCI armazenados em texto plano no banco de dados            | Sanitizar `requestBody` antes de armazenar, removendo campos de cartÃ£o |

### ğŸŸ¡ ATENÃ‡ÃƒO

| #   | Arquivo                                                 | Linha            | DescriÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Impacto                                                         | SugestÃ£o                                                              |
| --- | ------------------------------------------------------- | ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------- | --------------------------------------------------------------------- |
| 7   | `src/lib/jwt.ts`                                        | 159, 220         | `console.error('Erro ao validar usuÃ¡rio no banco:', error)` â€” Loga erro de validaÃ§Ã£o JWT sem sanitizaÃ§Ã£o em `validateRequest()` e `validateJWTRequest()`. O erro pode conter informaÃ§Ãµes sobre a estrutura do token. **Nota:** `verifyJWT()` foi melhorado â€” agora filtra erros esperados (expired/invalid/JWS/JWT) e sÃ³ loga erros inesperados com `[JWT_VERIFY_ERROR]`. PorÃ©m as funÃ§Ãµes `validateRequest` e `validateJWTRequest` ainda usam `console.error` direto para erros de banco. | PossÃ­vel exposiÃ§Ã£o de detalhes internos de autenticaÃ§Ã£o         | Usar `safeError` nas funÃ§Ãµes `validateRequest` e `validateJWTRequest` |
| 8   | `src/lib/notification-scheduler.ts`                     | 104              | `console.error('Error sending welcome notification to user ${user.id}:', error)` â€” Loga user ID + erro completo. O erro pode conter dados de configuraÃ§Ã£o (API keys do WhatsApp/SES)                                                                                                                                                                                                                                                                                                       | ExposiÃ§Ã£o de IDs de usuÃ¡rio e possÃ­veis credenciais de serviÃ§os | Usar `safeError` e nÃ£o interpolar user.id diretamente                 |
| 9   | `src/lib/notification-scheduler.ts`                     | 145              | `console.error('Error sending payment reminder to user ${user.id}:', error)` â€” Mesmo problema do item 8                                                                                                                                                                                                                                                                                                                                                                                    | ExposiÃ§Ã£o de IDs de usuÃ¡rio e possÃ­veis credenciais             | Usar `safeError`                                                      |
| 10  | `src/workers/notification-worker.ts`                    | 53               | `console.error('Falha ao processar notificaÃ§Ã£o:', job?.id, err)` â€” Loga erro completo do worker sem sanitizaÃ§Ã£o. O `err` pode conter dados da notificaÃ§Ã£o (email, telefone, conteÃºdo)                                                                                                                                                                                                                                                                                                      | ExposiÃ§Ã£o de dados de notificaÃ§Ã£o em logs do worker             | Usar `safeError`                                                      |
| 11  | `src/app/api/v1/settings/whatsapp/test/route.ts`        | 50               | `console.error('Erro da Evolution API:', errorBody)` â€” Loga corpo de erro da Evolution API sem sanitizaÃ§Ã£o. Pode conter dados de configuraÃ§Ã£o da instÃ¢ncia                                                                                                                                                                                                                                                                                                                                 | ExposiÃ§Ã£o de detalhes da API do WhatsApp                        | Usar `safeError`                                                      |
| 12  | `src/db/drizzle.ts`                                     | 21               | `console.error('Unexpected database pool error:', err)` â€” Loga erro do pool de conexÃ£o sem sanitizaÃ§Ã£o. Pode conter connection string com credenciais                                                                                                                                                                                                                                                                                                                                      | PossÃ­vel exposiÃ§Ã£o de credenciais do banco de dados             | Logar apenas `err.message`, nÃ£o o objeto completo                     |
| 13  | `src/lib/cache.ts`                                      | 13, 24, 34, 54   | `console.error('[CACHE_*_ERROR]', key, error)` â€” Loga chave do cache + erro completo. Chaves de cache podem conter IDs de usuÃ¡rio ou dados de sessÃ£o                                                                                                                                                                                                                                                                                                                                       | ExposiÃ§Ã£o de chaves de cache e erros internos do Redis          | Usar `safeError`                                                      |
| 14  | `src/lib/rate-limit.ts`                                 | 23               | `console.error('[RATE_LIMIT_ERROR]', routeKey, error)` â€” Loga chave de rota + erro completo do Redis                                                                                                                                                                                                                                                                                                                                                                                       | ExposiÃ§Ã£o de detalhes internos de rate limiting                 | Usar `safeError`                                                      |
| 15  | `src/components/contributions/hooks/useContribution.ts` | 59               | `devLog('Form data updated:', data)` â€” Loga atualizaÃ§Ãµes parciais do formulÃ¡rio que podem conter dados pessoais                                                                                                                                                                                                                                                                                                                                                                            | ExposiÃ§Ã£o de dados pessoais no console do navegador (dev)       | Logar apenas nomes dos campos atualizados, nÃ£o valores                |
| 16  | `src/components/contributions/hooks/usePaymentSync.ts`  | 34, 49, 103, 184 | MÃºltiplos `devLog` que logam `transactionId`, erros e dados de resposta de pagamento                                                                                                                                                                                                                                                                                                                                                                                                       | ExposiÃ§Ã£o de IDs de transaÃ§Ã£o e dados de pagamento no console   | Reduzir logging a informaÃ§Ãµes nÃ£o-sensÃ­veis                           |

### ğŸŸ¢ SUGESTÃƒO

| #   | Arquivo                                 | Linha    | DescriÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                   | Impacto                                          | SugestÃ£o                                                 |
| --- | --------------------------------------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------ | -------------------------------------------------------- |
| 17  | `src/lib/notification-hooks.ts`         | 604-622  | FunÃ§Ã£o `testNotifications()` com `console.log('Welcome result:', welcomeResult)` e `console.log('Reminder result:', reminderResult)` â€” CÃ³digo de teste em produÃ§Ã£o. **Nota:** O restante do arquivo foi migrado para usar `logger` estruturado (com `logger.info`, `logger.warn`, `logger.error`), mas esta funÃ§Ã£o de teste ainda usa `console.log`/`console.error` direto. | Debug statements em cÃ³digo de produÃ§Ã£o           | Remover funÃ§Ã£o de teste ou proteger com flag de ambiente |
| 18  | `src/workers/notification-worker.ts`    | 28, 32   | `console.log('Redis connected successfully')` e `console.log('Redis ready to receive commands')` â€” Logs informativos sem dados sensÃ­veis, mas desnecessÃ¡rios em produÃ§Ã£o                                                                                                                                                                                                    | RuÃ­do em logs de produÃ§Ã£o                        | Usar `logger.info()` do logger estruturado               |
| 19  | `src/lib/queues.ts`                     | 21, 25   | `console.log('Redis connected successfully')` e `console.log('Redis ready to accept commands')` â€” DuplicaÃ§Ã£o dos logs do worker                                                                                                                                                                                                                                             | RuÃ­do em logs de produÃ§Ã£o                        | Usar `logger.info()`                                     |
| 20  | `src/db/drizzle.ts`                     | 25, 29   | `console.log('Database connection established')` e `console.log('Database connection removed from pool')` â€” Logs informativos                                                                                                                                                                                                                                               | RuÃ­do em logs de produÃ§Ã£o                        | Usar `logger.info()`                                     |
| 21  | `src/lib/notification-scheduler.ts`     | 193, 197 | `console.log('Running notification scheduler...')` e `console.log('Notification scheduler completed')` â€” Logs informativos                                                                                                                                                                                                                                                  | RuÃ­do em logs de produÃ§Ã£o                        | Usar `logger.info()`                                     |
| 22  | `src/components/contributions/utils.ts` | 271      | `devLog` usa `console.log` diretamente sem sanitizaÃ§Ã£o â€” embora sÃ³ execute em dev, nÃ£o sanitiza dados                                                                                                                                                                                                                                                                       | Dados sensÃ­veis podem aparecer no console em dev | Integrar `sanitizeLog` do `log-sanitizer.ts` no `devLog` |

---

## AnÃ¡lise do UtilitÃ¡rio de SanitizaÃ§Ã£o

### `src/lib/log-sanitizer.ts` âœ… Bem implementado

**Campos sanitizados:**

- CPF (mascarado parcialmente)
- CartÃ£o de crÃ©dito (Ãºltimos 4 dÃ­gitos)
- CVV (completamente mascarado)
- Senhas em JSON (`"password": "[REDACTED]"`)
- Tokens em JSON (`"token": "[REDACTED]"`)
- Bearer tokens (`Bearer [REDACTED]`)
- Security code (`"securityCode": "[REDACTED]"`)

**Campos redatados em objetos:**

- `password`, `token`, `securityCode`, `cvv`, `cardNumber`, `number`, `expirationDate`, `holder`, `brand`

**Problema:** O sanitizador Ã© robusto, mas **nÃ£o Ã© usado consistentemente** no projeto. Apenas `src/lib/cielo.ts` e `src/lib/notifications.ts` usam `safeLog`/`safeError`.

### `src/lib/logger.ts` âœ… Bem implementado

**SanitizaÃ§Ã£o prÃ³pria** com campos adicionais: `jwt`, `secret`, `apiKey`, `cardholderName`

**Problema:** O `Logger` estruturado **quase nÃ£o Ã© usado** no cÃ³digo. A maioria dos mÃ³dulos usa `console.error` diretamente.

---

## Resumo de Severidade

| Severidade  | Quantidade | Corrigidos   |
| ----------- | ---------- | ------------ |
| ğŸ”´ CRÃTICO  | 6          | âœ… 6/6       |
| ğŸŸ¡ ATENÃ‡ÃƒO  | 10         | âœ… 10/10     |
| ğŸŸ¢ SUGESTÃƒO | 6          | âœ… 6/6       |
| **Total**   | **22**     | **âœ… 22/22** |

> **CorreÃ§Ãµes aplicadas:**
>
> - ğŸ”´ #1-3: `devLog` sanitizado â€” removidos dados de cartÃ£o (holder), form data completo e respostas de pagamento. Agora logam apenas campos nÃ£o-sensÃ­veis.
> - ğŸ”´ #4: `api-error-handler.ts` migrado para `safeError` do `log-sanitizer.ts`
> - ğŸ”´ #5: `api-auth.ts` agora loga apenas `error.message` em vez do objeto completo
> - ğŸ”´ #6: `cielo-logger.ts` agora sanitiza `requestBody` e `responseBody` via `sanitizeLog()` antes de armazenar no banco
> - ğŸŸ¡ #7: `jwt.ts` â€” `validateRequest` e `validateJWTRequest` agora logam apenas `error.message`
> - ğŸŸ¡ #8-9: `notification-scheduler.ts` â€” erros agora logam apenas `error.message`
> - ğŸŸ¡ #10: `notification-worker.ts` â€” failed handler agora loga apenas `err.message`
> - ğŸŸ¡ #11: `whatsapp/test/route.ts` â€” errorBody sanitizado, loga apenas status e message
> - ğŸŸ¡ #12: `drizzle.ts` â€” pool error agora loga apenas `err.message`
> - ğŸŸ¡ #13: `cache.ts` â€” todos os 4 catch blocks agora logam apenas `error.message`
> - ğŸŸ¡ #14: `rate-limit.ts` â€” agora loga apenas `error.message`
> - ğŸŸ¡ #15-16: `usePaymentSync.ts` â€” devLogs de erro agora logam apenas `error.message`
> - ğŸŸ¢ #17: `notification-hooks.ts` â€” `testNotifications` protegida com guard de produÃ§Ã£o, migrada para `logger`
> - ğŸŸ¢ #18-19: `notification-worker.ts` e `queues.ts` â€” `console.log` informativos migrados para `console.warn`
> - ğŸŸ¢ #20: `drizzle.ts` â€” `console.log` informativos migrados para `console.warn`
> - ğŸŸ¢ #21: `notification-scheduler.ts` â€” `console.log` informativos migrados para `console.warn`
> - ğŸŸ¢ #22: `utils.ts` â€” `devLog` agora sanitiza todos os argumentos via `sanitizeLog()` antes de logar

---

## RecomendaÃ§Ãµes PrioritÃ¡rias

1. **ğŸ”´ Migrar `api-error-handler.ts` para usar `safeError`** â€” Ã‰ o handler centralizado de erros, afeta todas as rotas
2. **ğŸ”´ Sanitizar dados de cartÃ£o no `cielo-logger.ts`** â€” Dados PCI nÃ£o devem ser armazenados em texto plano
3. **ğŸ”´ Remover/sanitizar `devLog` de dados de cartÃ£o** â€” Mesmo em dev, dados PCI nÃ£o devem ser logados
4. **ğŸŸ¡ Criar regra de lint** para proibir `console.log`/`console.error` direto e forÃ§ar uso de `safeLog`/`safeError` ou `logger`
5. **ğŸŸ¡ Unificar estratÃ©gia de logging** â€” Escolher entre `log-sanitizer.ts` e `logger.ts` e usar consistentemente
