# 5.2 Chamadas √† Cielo API sem Controle de Idempot√™ncia

**Requisito:** 3.2 ‚Äî Identificar chamadas de cria√ß√£o de cobran√ßa sem controle de Idempot√™ncia
**Data:** An√°lise est√°tica do c√≥digo-fonte
**√öltima verifica√ß√£o:** Fevereiro 2026

---

## Resumo

O sistema possui **3 fun√ß√µes de cria√ß√£o de pagamento** na Cielo API (`src/lib/cielo.ts`):

- `createPixPayment`
- `createCreditCardPayment`
- `createBoletoPayment`

Existe **1 √∫nico call site** que invoca essas fun√ß√µes: `src/app/api/v1/transacoes/route.ts` (POST handler).

O guard de idempot√™ncia (`checkDuplicatePayment` de `src/lib/payment-guard.ts`) **√© chamado corretamente** antes de qualquer cria√ß√£o de pagamento nesse call site.

---

## An√°lise Detalhada

### 1. Guard de Idempot√™ncia ‚Äî `src/lib/payment-guard.ts`

A fun√ß√£o `checkDuplicatePayment` verifica se j√° existe uma transa√ß√£o `pending` ou `approved` para o mesmo `userId` e `amount` dentro de uma janela de tempo (padr√£o: 5 minutos).

**Implementa√ß√£o verificada:**

- Busca na tabela `transactions` por `contributorId`, `amount`, `status IN ('pending', 'approved')` e `createdAt >= windowStart`
- Retorna `{ isDuplicate: boolean, existingTransaction? }`
- Usa `.limit(1)` ‚úÖ

### 2. Call Site ‚Äî `src/app/api/v1/transacoes/route.ts` (POST)

**Fluxo do handler POST verificado:**

1. ‚úÖ Rate limiting (10 req/min via Redis)
2. ‚úÖ Autentica√ß√£o JWT (`validateRequest()`)
3. ‚úÖ Valida√ß√£o Zod (`transactionSchema.parse(body)`)
4. ‚úÖ **`checkDuplicatePayment(user.id, data.amount, 5)`** ‚Äî chamado antes de qualquer cria√ß√£o
5. ‚úÖ Se duplicado, retorna HTTP 409 com `existingTransactionId`
6. ‚úÖ Busca perfil do usu√°rio com `.limit(1)` em todas as queries
7. S√≥ ent√£o chama `createPixPayment`, `createCreditCardPayment` ou `createBoletoPayment`
8. ‚úÖ Insere transa√ß√£o no banco ap√≥s resposta da Cielo
9. ‚úÖ Invalida cache do dashboard e relat√≥rios

### 3. Fun√ß√µes de Pagamento ‚Äî `src/lib/cielo.ts`

As fun√ß√µes de cria√ß√£o de pagamento **n√£o possuem controle de idempot√™ncia interno**. Elas confiam que o caller j√° fez a verifica√ß√£o. Isso √© aceit√°vel dado que existe apenas 1 call site.

Verifica√ß√µes adicionais confirmadas:

- ‚úÖ `cieloFetch` usa `AbortController` com timeout de 15s (compat√≠vel com Edge Runtime)
- ‚úÖ Logging estruturado via `logCieloRequest`/`logCieloResponse`
- ‚úÖ Tratamento de erros com mensagens espec√≠ficas por tipo de pagamento

### 4. Outros Call Sites

Busca exaustiva confirmou que **n√£o existem outros call sites** que chamam fun√ß√µes de cria√ß√£o:

- `src/app/api/v1/transacoes/[id]/sync/route.ts` ‚Äî importa apenas `queryPayment` (consulta) ‚úÖ
- `src/app/api/v1/transacoes/[id]/refund/route.ts` ‚Äî importa apenas `cancelPayment` (cancelamento) ‚úÖ
- Nenhum worker, cron job ou server action cria pagamentos diretamente ‚úÖ

### 5. Prote√ß√£o no Frontend ‚Äî `useContribution.ts`

O hook `useContribution` usa flag `isProcessing` para prevenir double-click no bot√£o de pagamento. Camada adicional de prote√ß√£o no cliente (n√£o substitui a verifica√ß√£o server-side).

---

## Problemas Encontrados (Fragilidades Arquiteturais)

### üü° ATEN√á√ÉO ‚Äî `MerchantOrderId` baseado em `Date.now()` (n√£o √© idempotent key)

| #   | Arquivo            | Linha | Valor Atual                                |
| --- | ------------------ | ----- | ------------------------------------------ |
| 1   | `src/lib/cielo.ts` | ~115  | `MerchantOrderId: \`PIX-${Date.now()}\``   |
| 2   | `src/lib/cielo.ts` | ~188  | `MerchantOrderId: \`ORDER-${Date.now()}\`` |
| 3   | `src/lib/cielo.ts` | ~276  | `MerchantOrderId: \`ORDER-${Date.now()}\`` |

**Impacto:** O `MerchantOrderId` deveria ser um identificador determin√≠stico vinculado √† transa√ß√£o do sistema. Usar `Date.now()` significa que se o `checkDuplicatePayment` falhar (race condition), a Cielo n√£o consegue detectar a duplica√ß√£o. Duas requisi√ß√µes no mesmo milissegundo poderiam gerar o mesmo ID (colis√£o).

**Sugest√£o futura:** Usar o ID da transa√ß√£o do banco ou hash determin√≠stico (`PIX-${transactionId}`).

### üü° ATEN√á√ÉO ‚Äî Race condition entre verifica√ß√£o e cria√ß√£o

| #   | Arquivo                              | Descri√ß√£o                                                        |
| --- | ------------------------------------ | ---------------------------------------------------------------- |
| 4   | `src/app/api/v1/transacoes/route.ts` | Janela entre `checkDuplicatePayment` e `db.insert(transactions)` |

**Impacto:** Se duas requisi√ß√µes chegarem quase simultaneamente, ambas podem passar pelo check de duplica√ß√£o antes que qualquer uma insira no banco. O rate limiting de 10 req/min mitiga parcialmente.

**Sugest√£o futura:** Inserir transa√ß√£o com status `processing` ANTES de chamar a Cielo, e atualizar ap√≥s resposta. Ou usar `SELECT FOR UPDATE` / lock distribu√≠do.

### üü° ATEN√á√ÉO ‚Äî Valores monet√°rios usando float

| #   | Arquivo            | Linha | Padr√£o                                      |
| --- | ------------------ | ----- | ------------------------------------------- |
| 5   | `src/lib/cielo.ts` | ~120  | `Amount: Math.round(amount * 100)` (PIX)    |
| 6   | `src/lib/cielo.ts` | ~198  | `Amount: Math.round(amount * 100)` (Cart√£o) |
| 7   | `src/lib/cielo.ts` | ~286  | `Amount: Math.round(amount * 100)` (Boleto) |

**Impacto:** O par√¢metro `amount` √© recebido como `number` (float). A convers√£o `amount * 100` pode gerar imprecis√£o de ponto flutuante (ex: `19.99 * 100 = 1998.9999999999998`). O `Math.round()` mitiga parcialmente. O schema Zod define `amount: z.number().min(1)` sem restri√ß√£o a inteiros.

**Sugest√£o futura:** Receber valores j√° em centavos (inteiros) desde o frontend.

---

## Conclus√£o

| Aspecto                                                  | Status                                      |
| -------------------------------------------------------- | ------------------------------------------- |
| `checkDuplicatePayment` chamado antes de criar pagamento | ‚úÖ OK                                       |
| √önico call site para fun√ß√µes de cria√ß√£o                  | ‚úÖ OK                                       |
| Rate limiting no endpoint (10 req/min Redis)             | ‚úÖ OK                                       |
| Timeout nas chamadas √† Cielo (15s AbortController)       | ‚úÖ OK                                       |
| Logging estruturado de request/response                  | ‚úÖ OK                                       |
| Prote√ß√£o double-click no frontend                        | ‚úÖ OK                                       |
| `MerchantOrderId` como idempotent key                    | üü° Fraco ‚Äî baseado em `Date.now()`          |
| Race condition entre check e create                      | üü° Poss√≠vel ‚Äî sem transa√ß√£o at√¥mica         |
| Valores monet√°rios em centavos                           | üü° Convers√£o de float ‚Äî risco de imprecis√£o |

**Veredicto geral:** O controle de idempot√™ncia **existe e est√° corretamente posicionado**. Os 3 problemas encontrados s√£o fragilidades arquiteturais de severidade üü° ATEN√á√ÉO que requerem refatora√ß√£o significativa para resolver. O guard principal funciona para o caso comum e o rate limiting adiciona uma camada extra de prote√ß√£o.

**Nenhuma corre√ß√£o de c√≥digo aplicada** ‚Äî os achados s√£o sugest√µes de melhoria arquitetural para implementa√ß√£o futura.
