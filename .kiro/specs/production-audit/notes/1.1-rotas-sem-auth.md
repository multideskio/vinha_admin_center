# An√°lise 1.1 ‚Äî Rotas API sem Autentica√ß√£o JWT

**Data:** An√°lise realizada como parte da auditoria de produ√ß√£o
**Requisito:** 2.1 ‚Äî Rotas protegidas devem usar `validateRequest()` ou `validateJWTRequest()`

## Resumo

- **Total de rotas analisadas:** 113 arquivos `route.ts` em `src/app/api/`
- **Rotas com autentica√ß√£o:** 97 (incluindo 2 corrigidas)
- **Rotas p√∫blicas leg√≠timas:** 16 (incluindo payment-methods reclassificada)
- **üî¥ Rotas protegidas SEM autentica√ß√£o:** 0 ‚úÖ

---

## Rotas P√∫blicas Leg√≠timas (sem auth ‚Äî correto)

| #   | Rota                                           | Justificativa                                                                             |
| --- | ---------------------------------------------- | ----------------------------------------------------------------------------------------- |
| 1   | `src/app/api/health/route.ts`                  | Health check ‚Äî deve ser p√∫blico                                                           |
| 2   | `src/app/api/auth/forgot-password/route.ts`    | Recupera√ß√£o de senha ‚Äî p√∫blico com rate limit ‚úÖ                                          |
| 3   | `src/app/api/auth/reset-password/route.ts`     | Redefini√ß√£o de senha ‚Äî p√∫blico com rate limit ‚úÖ                                          |
| 4   | `src/app/api/auth/verify-token/route.ts`       | Verifica√ß√£o de token de reset ‚Äî p√∫blico                                                   |
| 5   | `src/app/api/evolution/webhook/route.ts`       | Webhook Evolution API ‚Äî p√∫blico (recebe eventos externos)                                 |
| 6   | `src/app/api/v1/auth/login/route.ts`           | Login ‚Äî p√∫blico com rate limit ‚úÖ                                                         |
| 7   | `src/app/api/v1/auth/register/church/route.ts` | Registro de igreja ‚Äî p√∫blico com rate limit ‚úÖ                                            |
| 8   | `src/app/api/v1/auth/register/pastor/route.ts` | Registro de pastor ‚Äî p√∫blico com rate limit ‚úÖ                                            |
| 9   | `src/app/api/v1/cep/route.ts`                  | Consulta ViaCEP ‚Äî p√∫blico (utilit√°rio)                                                    |
| 10  | `src/app/api/v1/company/public/route.ts`       | Dados p√∫blicos da empresa ‚Äî p√∫blico por design                                            |
| 11  | `src/app/api/v1/maintenance-check/route.ts`    | Verifica√ß√£o de manuten√ß√£o ‚Äî p√∫blico                                                       |
| 12  | `src/app/api/v1/sns/webhook/route.ts`          | Webhook AWS SNS ‚Äî p√∫blico (valida assinatura SNS) ‚úÖ                                      |
| 13  | `src/app/api/v1/webhooks/cielo/route.ts`       | Webhook Cielo ‚Äî p√∫blico (recebe eventos de pagamento)                                     |
| 14  | `src/app/api/cron/notifications/route.ts`      | Cron job ‚Äî autenticado via CRON_SECRET (timing-safe) ‚úÖ                                   |
| 15  | `src/app/api/v1/cron/notifications/route.ts`   | Cron job ‚Äî autenticado via CRON_SECRET                                                    |
| 16  | `src/app/api/v1/payment-methods/route.ts`      | M√©todos de pagamento ‚Äî p√∫blico por design (formul√°rio de contribui√ß√£o), com rate limit ‚úÖ |

---

## ‚úÖ Rotas Corrigidas (anteriormente sem autentica√ß√£o)

### 1. `src/app/api/v1/gerente/dashboard/route.ts` ‚Äî CORRIGIDO ‚úÖ

- **Severidade original:** üî¥ CR√çTICO
- **Problema:** Usava `process.env.GERENTE_INIT` como ID fixo sem autentica√ß√£o JWT.
- **Corre√ß√£o aplicada (Task 9.2):**
  - Adicionado `validateRequest()` com verifica√ß√£o `user.role !== 'manager'`
  - Substitu√≠do `GERENTE_INIT` por `user.id` do token JWT
  - Retorna 401 se n√£o autenticado ou role incorreto
- **Status:** ‚úÖ Corrigido e verificado

### 2. `src/app/api/v1/gerente/perfil/route.ts` ‚Äî CORRIGIDO ‚úÖ

- **Severidade original:** üî¥ CR√çTICO
- **Problema:** Usava `process.env.GERENTE_INIT` como ID fixo sem autentica√ß√£o JWT (GET e PUT).
- **Corre√ß√£o aplicada (Task 9.2):**
  - Adicionado `validateRequest()` com verifica√ß√£o `user.role !== 'manager'` em GET e PUT
  - Substitu√≠do `GERENTE_INIT` por `user.id` do token JWT
  - Adicionado schema Zod `managerUpdateSchema` para valida√ß√£o do PUT
  - Retorna 401 se n√£o autenticado ou role incorreto
- **Status:** ‚úÖ Corrigido e verificado

### 3. `src/app/api/v1/payment-methods/route.ts` ‚Äî Reclassificado como p√∫blico ‚úÖ

- **Severidade original:** üü° ATEN√á√ÉO
- **Avalia√ß√£o:** Rota retorna apenas a lista de m√©todos de pagamento aceitos (pix, cart√£o, boleto). √â usada no formul√°rio de contribui√ß√£o que pode ser acessado antes do login. Possui rate limiting (30 req/min). N√£o exp√µe dados sens√≠veis.
- **Decis√£o:** Reclassificada como rota p√∫blica leg√≠tima. Adicionada √† tabela de rotas p√∫blicas.
- **Status:** ‚úÖ P√∫blico por design ‚Äî sem a√ß√£o necess√°ria

---

## Notas Adicionais

### Rotas legado do gerente (`/v1/gerente/`)

As rotas `/v1/gerente/dashboard` e `/v1/gerente/perfil` eram rotas **legado** que usavam um ID fixo de ambiente (`GERENTE_INIT`). Foram corrigidas na Task 9.2 para usar `validateRequest()` com verifica√ß√£o de role e `user.id` do JWT. O sistema tamb√©m possui rotas equivalentes em `/v1/manager/` que j√° usavam `validateRequest()` corretamente.

### Cron jobs

Ambos os cron jobs (`/api/cron/notifications` e `/api/v1/cron/notifications`) usam autentica√ß√£o via `CRON_SECRET` no header Authorization, o que √© o padr√£o correto para cron jobs. O da raiz usa `timingSafeEqual` (mais seguro), enquanto o v1 usa compara√ß√£o direta de string.

### Webhooks

Os webhooks (Cielo, SNS, Evolution) s√£o corretamente p√∫blicos pois recebem eventos de servi√ßos externos. O webhook SNS valida a assinatura SNS, o que √© uma boa pr√°tica.
