# 5.1 â€” Queries `db.select()` sem `.limit()` que podem retornar conjuntos grandes

**Data:** 2025-01-07
**Requisito:** 3.1 â€” Identificar queries SELECT sem .limit() que podem retornar conjuntos grandes de dados
**Ãšltima verificaÃ§Ã£o:** Fevereiro 2026

## Metodologia

- Busca por `db.select(` em todos os arquivos `.ts` dentro de `src/`
- VerificaÃ§Ã£o manual de cada cadeia de chamadas para presenÃ§a de `.limit()`
- **ExcluÃ­das:** queries que filtram por ID Ãºnico com destructuring (`const [result] = ...where(eq(table.id, id)).limit(1)`)
- **ExcluÃ­das:** queries de agregaÃ§Ã£o pura (`count()`, `sum()`) que retornam 1 linha por natureza
- **ExcluÃ­das:** queries com `groupBy()` que retornam poucas linhas por natureza (ex: group by role, group by status, group by paymentMethod)

## Resumo Atual

| Severidade  | Quantidade Original | Corrigidos | Restantes |
| ----------- | ------------------- | ---------- | --------- |
| ğŸ”´ CRÃTICO  | 3                   | 3          | **0**     |
| ğŸŸ¡ ATENÃ‡ÃƒO  | 22                  | 22         | **0**     |
| ğŸŸ¢ SUGESTÃƒO | 5                   | 5          | **0**     |
| **Total**   | **30**              | **30**     | **0**     |

âœ… **Todos os 30 achados foram corrigidos.**

## CorreÃ§Ãµes Verificadas

### ğŸ”´ CRÃTICO â€” Todos corrigidos

| #   | Arquivo                                                                         | CorreÃ§Ã£o Aplicada          | Status       |
| --- | ------------------------------------------------------------------------------- | -------------------------- | ------------ |
| 1   | `src/app/api/v1/transacoes/export/route.ts`                                     | `.limit(10000)` adicionado | âœ… Corrigido |
| 2   | `src/lib/report-services/general-report.ts` (`fetchFinancialTransactions`)      | `.limit(5000)` adicionado  | âœ… Corrigido |
| 3   | `src/lib/report-services/general-report.ts` (`fetchPaymentsByContributorMonth`) | `.limit(50000)` adicionado | âœ… Corrigido |

### ğŸŸ¡ ATENÃ‡ÃƒO â€” Todos corrigidos

| #     | Arquivo                                                     | CorreÃ§Ã£o Aplicada                                                       | Status                     |
| ----- | ----------------------------------------------------------- | ----------------------------------------------------------------------- | -------------------------- |
| 4     | `src/app/api/v1/webhooks/route.ts`                          | `.limit(100)`                                                           | âœ… Corrigido               |
| 5     | `src/app/api/v1/users/[id]/notification-settings/route.ts`  | `.limit(10)`                                                            | âœ… Corrigido               |
| 6     | `src/app/api/v1/users/[id]/fraud-stats/route.ts` (fraudes)  | `.limit(100)`                                                           | âœ… Corrigido               |
| 7     | `src/app/api/v1/users/[id]/fraud-stats/route.ts` (contagem) | Corrigido: `sql\`COUNT(\*)\``em vez de`.select().length` (bug lÃ³gico)   | âœ… Corrigido nesta revisÃ£o |
| 8     | `src/app/api/v1/templates/route.ts`                         | `.limit(100)` em ambas queries                                          | âœ… Corrigido               |
| 9     | `src/app/api/v1/supervisores/route.ts`                      | `.limit(200)` + paginaÃ§Ã£o com `.limit(limit).offset(offset)` no minimal | âœ… Corrigido               |
| 10-11 | `src/app/api/v1/regioes/route.ts` (GET minimal e completo)  | `.limit(100)` em ambas                                                  | âœ… Corrigido               |
| 12    | `src/app/api/v1/regioes/route.ts` (POST unicidade)          | `.limit(1)`                                                             | âœ… Corrigido               |
| 13    | `src/app/api/v1/notification-rules/route.ts`                | `.limit(100)`                                                           | âœ… Corrigido               |
| 14    | `src/app/api/v1/pastores/route.ts` (minimal, admin)         | `.limit(500)`                                                           | âœ… Corrigido               |
| 15    | `src/app/api/v1/pastores/route.ts` (minimal, manager)       | `.limit(500)`                                                           | âœ… Corrigido               |
| 16    | `src/app/api/v1/pastores/route.ts` (minimal, supervisor)    | `.limit(200)`                                                           | âœ… Corrigido               |
| 17    | `src/app/api/v1/pastores/route.ts` (completo, admin)        | `.limit(500)`                                                           | âœ… Corrigido               |
| 18    | `src/app/api/v1/pastores/route.ts` (completo, manager)      | `.limit(500)`                                                           | âœ… Corrigido               |
| 19    | `src/app/api/v1/pastores/route.ts` (completo, supervisor)   | `.limit(200)`                                                           | âœ… Corrigido               |
| 20    | `src/app/api/v1/igrejas/route.ts` (minimal)                 | `.limit(500)`                                                           | âœ… Corrigido               |
| 21    | `src/app/api/v1/igrejas/route.ts` (completo, admin)         | `.limit(500)`                                                           | âœ… Corrigido               |
| 22    | `src/app/api/v1/igrejas/route.ts` (completo, manager)       | `.limit(500)`                                                           | âœ… Corrigido               |
| 23    | `src/app/api/v1/igrejas/route.ts` (completo, supervisor)    | `.limit(200)`                                                           | âœ… Corrigido               |
| 24    | `src/app/api/v1/administradores/route.ts`                   | `.limit(50)`                                                            | âœ… Corrigido               |
| 25    | `src/app/api/v1/gateways/route.ts`                          | `.limit(10)`                                                            | âœ… Corrigido               |
| 26    | `src/app/api/v1/api-keys/route.ts`                          | `.limit(50)`                                                            | âœ… Corrigido               |
| 27    | `src/app/api/v1/send-message/route.ts`                      | `.limit(1)`                                                             | âœ… Corrigido               |

### ğŸŸ¡ ATENÃ‡ÃƒO â€” Dashboard/RelatÃ³rios â€” Todos corrigidos

| #   | Arquivo                                                             | CorreÃ§Ã£o Aplicada | Status                     |
| --- | ------------------------------------------------------------------- | ----------------- | -------------------------- |
| 28  | `src/app/api/v1/dashboard/admin/route.ts` (revenueByRegionPastors)  | `.limit(100)`     | âœ… Corrigido               |
| 28b | `src/app/api/v1/dashboard/admin/route.ts` (revenueByRegionChurches) | `.limit(100)`     | âœ… Corrigido nesta revisÃ£o |
| 29  | `src/app/api/v1/dashboard/admin/route.ts` (pastorsWithTitheDay)     | `.limit(1000)`    | âœ… Corrigido               |
| 30  | `src/app/api/v1/dashboard/admin/route.ts` (churchesWithTitheDay)    | `.limit(1000)`    | âœ… Corrigido               |

### Report services â€” Limites adicionais verificados

| Arquivo                                   | Query                       | Limite            |
| ----------------------------------------- | --------------------------- | ----------------- |
| `general-report.ts` (`fetchPastors`)      | Pastores para inadimplÃªncia | `.limit(1000)` âœ… |
| `general-report.ts` (`fetchChurches`)     | Igrejas para inadimplÃªncia  | `.limit(1000)` âœ… |
| `general-report.ts` (`fetchChurchesList`) | Lista de igrejas            | `.limit(500)` âœ…  |

### Lookups por ID â€” Todos com `.limit(1)`

| Arquivo                                            | Status                                       |
| -------------------------------------------------- | -------------------------------------------- |
| `src/app/api/v1/supervisores/[id]/route.ts`        | âœ… `.limit(1)`                               |
| `src/app/api/v1/pastores/[id]/route.ts`            | âœ… `.limit(1)`                               |
| `src/app/api/v1/igrejas/[id]/route.ts`             | âœ… `.limit(1)`                               |
| `src/app/api/v1/transacoes/[id]/route.ts`          | âœ… `.limit(1)`                               |
| `src/app/api/v1/transacoes/[id]/resend/route.ts`   | âœ… `.limit(1)`                               |
| `src/app/api/v1/layout-data/route.ts` (2 queries)  | âœ… `.limit(1)`                               |
| `src/app/api/v1/users/[id]/quick-profile/route.ts` | âœ… `.limit(1)` em todas as queries de lookup |
| `src/app/api/v1/webhooks/cielo/route.ts`           | âœ… `.limit(1)` em todas                      |
| `src/app/api/v1/gerente/perfil/route.ts`           | âœ… `.limit(1)`                               |
| `src/app/api/v1/send-message/route.ts`             | âœ… `.limit(1)`                               |

## CorreÃ§Ãµes Aplicadas Nesta RevisÃ£o

| #   | Arquivo                                            | CorreÃ§Ã£o                                                                                                                           |
| --- | -------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| 1   | `src/app/api/v1/users/[id]/fraud-stats/route.ts`   | Bug lÃ³gico: `.select({ count: id }).limit(1)` + `.length` sempre retornava 0 ou 1. Corrigido para `sql\`COUNT(\*)\``com`.limit(1)` |
| 2   | `src/app/api/v1/dashboard/admin/route.ts`          | `revenueByRegionChurches` nÃ£o tinha `.limit()`. Adicionado `.limit(100)`                                                           |
| 3   | `src/app/api/v1/users/[id]/quick-profile/route.ts` | Query de igrejas do pastor sem `.limit()`. Adicionado `.limit(100)`                                                                |

## Queries corretamente excluÃ­das (com `.limit()` ou paginaÃ§Ã£o)

- `src/lib/company.ts` â€” `.limit(1)` âœ…
- `src/app/api/auth/forgot-password/route.ts` â€” `.limit(1)` âœ…
- `src/app/api/v1/transacoes/route.ts` (GET) â€” `.limit(limit).offset(offset)` âœ…
- `src/app/api/v1/email-blacklist/route.ts` â€” `.limit(limit).offset(offset)` âœ…
- `src/app/api/v1/notification-logs/route.ts` â€” SQL raw com `LIMIT/OFFSET` âœ…
- `src/app/api/v1/manager/transacoes/route.ts` â€” `.limit(limit).offset(offset)` âœ…
- `src/lib/report-services/membership-report.ts` â€” `.limit(params.limit).offset(offset)` âœ…

## ConclusÃ£o

âœ… **Todas as 30 queries identificadas na auditoria original agora possuem `.limit()` adequado.** AlÃ©m disso, 3 problemas adicionais foram encontrados e corrigidos nesta revisÃ£o (bug lÃ³gico no fraud-stats, limit faltando no revenueByRegionChurches, e limit faltando no quick-profile). CompilaÃ§Ã£o TypeScript limpa (`tsc --noEmit` exit code 0).
