# 5.3 ‚Äî Loops com chamadas HTTP ou queries ao banco (N+1)

**Requisito:** 3.3
**Data:** An√°lise est√°tica do c√≥digo-fonte
**√öltima verifica√ß√£o:** 10/02/2026

## Resumo

Foram encontrados **8 padr√µes N+1** significativos em **5 arquivos**. **3 foram corrigidos**, 5 permanecem como sugest√µes arquiteturais.

---

## Achados

### üî¥ CR√çTICO

#### 1. `src/app/api/v1/admin/send-reminders/route.ts`

**Status:** ‚úÖ CORRIGIDO

**Corre√ß√µes aplicadas:**

- `NotificationService.createFromDatabase(companyId)` movido para **fora dos loops** ‚Äî criado uma √∫nica vez e reutilizado para todos os usu√°rios
- Dedup individual (`await db.select()` por usu√°rio) substitu√≠do por **batch com `inArray()`** ‚Äî uma query busca todos os logs existentes, monta `Set`, e verifica no loop sem queries
- Aplicado nos dois loops: `reminderRules` e `overdueRules`

**Antes:** 500 usu√°rios √ó 2 regras = ~5.000 queries (dedup + service + logs)
**Depois:** 2 regras √ó (1 query users + 1 query dedup batch) + inserts de log = ~6 queries + inserts

---

#### 2. `src/app/api/v1/transacoes/export/route.ts`

**Status:** ‚úÖ CORRIGIDO

**Corre√ß√µes aplicadas:**

- `Promise.all(data.map(async (t) => { await db.select()... }))` (query por transa√ß√£o) substitu√≠do por **4 queries batch com `inArray()`** ‚Äî uma por role (manager, supervisor, pastor, church_account)
- Perfis carregados em `Map<userId, nome>` e usados no `.map()` s√≠ncrono

**Antes:** 10.000 transa√ß√µes = 10.000 queries paralelas ao banco
**Depois:** 4 queries batch (uma por role) + map s√≠ncrono

---

### üü° ATEN√á√ÉO

#### 3. `src/app/api/v1/notification-rules/bootstrap/route.ts`

**Status:** ‚ö†Ô∏è N+1 PRESENTE (baixo impacto)

**Padr√£o:** `for (const tpl of defaultTemplates)` ‚Üí `await db.select()` + `await db.insert()`

**Detalhes:** 2 templates + 3 regras = **5 itera√ß√µes fixas** (n√£o cresce com dados). Cada itera√ß√£o faz SELECT com `.limit(1)` para verificar exist√™ncia + INSERT se n√£o existir. Total: 10 queries onde poderiam ser 2.

**Impacto:** Baixo ‚Äî apenas 5 itera√ß√µes fixas. Rota chamada raramente (bootstrap inicial).

**Sugest√£o:** Usar `INSERT ... ON CONFLICT DO NOTHING` ou buscar todos existentes de uma vez com `inArray`.

---

#### 4. `src/lib/notification-scheduler.ts` ‚Äî `processWelcomeNotifications()`

**Status:** ‚ö†Ô∏è N+1 PRESENTE (arquitetural)

**Padr√£o:** `for (const user of newUsers)` ‚Üí `sendWelcomeNotification(user)` ‚Üí `getCompanySettings()` + `NotificationService` + HTTP

**Detalhes:** `getCompanySettings()` faz query individual ao banco por usu√°rio (com `.limit(1)`). `new NotificationService()` criado por usu√°rio com os mesmos settings da mesma empresa. **Sem `.limit()`** na query de `newUsers`.

**Impacto:** M√©dio. A query de `getCompanySettings` √© repetida para cada usu√°rio da mesma empresa.

**Sugest√£o:** Agrupar usu√°rios por `companyId`, buscar settings uma vez por empresa, criar `NotificationService` uma vez por empresa. Adicionar `.limit()` na query de `newUsers`.

---

#### 5. `src/lib/notification-scheduler.ts` ‚Äî `processPaymentReminders()`

**Status:** ‚ö†Ô∏è N+1 PRESENTE (arquitetural)

**Padr√£o:** `for (const user of usersToRemind)` ‚Üí `sendPaymentReminder(user)` ‚Üí `getCompanySettings()` + `NotificationService` + HTTP

**Detalhes:** Mesma estrutura do achado #4. **Sem `.limit()`** na query de `usersToRemind`.

**Sugest√£o:** Mesma do achado #4 ‚Äî agrupar por empresa e cachear settings. Adicionar `.limit()`.

---

#### 6. `src/lib/notification-hooks.ts` ‚Äî `processNotificationEvent()`

**Status:** ‚úÖ CORRIGIDO

**Corre√ß√£o aplicada:** `new NotificationService()` movido para **fora do loop** `for (const rule of activeRules)` ‚Äî criado uma √∫nica vez com os settings j√° buscados e reutilizado para todas as regras.

**Antes:** N regras √ó 1 inst√¢ncia = N inst√¢ncias id√™nticas
**Depois:** 1 inst√¢ncia reutilizada para todas as regras

---

#### 7. `src/app/api/v1/sns/webhook/route.ts` ‚Äî `handleBounce()` e `handleComplaint()`

**Status:** ‚ö†Ô∏è N+1 PRESENTE (baixo impacto)

**Padr√£o:** `for (const recipient of bounce.bouncedRecipients)` ‚Üí SELECT + UPDATE/INSERT + INSERT log

**Detalhes:** 3 queries por destinat√°rio. J√° usa `.limit(1)`.

**Impacto:** Baixo ‚Äî bounces/complaints geralmente t√™m 1-3 destinat√°rios.

**Sugest√£o:** Buscar todos os emails existentes na blacklist de uma vez e fazer batch insert/update.

---

#### 8. `src/app/api/v1/cron/notifications/route.ts`

**Status:** ‚ö†Ô∏è N+1 PARCIALMENTE OTIMIZADO (j√° existente)

**Detalhes:**

- ‚úÖ `processPayments()`, `processReminders()`, `processOverdue()` ‚Äî j√° otimizados com dedup batch via `inArray()` e `Set`
- ‚ö†Ô∏è `processNewUsers()` ‚Äî ainda cria `new NotificationService()` por usu√°rio
- `.limit(50)` em `processNewUsers`, `.limit(100)` em `processReminders`/`processOverdue`, `.limit(50)` em `processPayments`

**Sugest√£o:** Agrupar por `companyId` e criar `NotificationService` uma vez por empresa.

---

### ‚ÑπÔ∏è Padr√µes N√ÉO-N+1 (falsos positivos descartados)

| Arquivo                                                        | Linha                  | Motivo                                              |
| -------------------------------------------------------------- | ---------------------- | --------------------------------------------------- |
| `src/lib/report-services/membership-report.ts`                 | 323                    | Itera√ß√£o sobre dados j√° carregados (Map)            |
| `src/lib/report-services/general-report.ts`                    | 516, 525, 636          | Itera√ß√£o sobre dados j√° carregados (formata√ß√£o)     |
| `src/lib/rate-limiter.ts`                                      | 34                     | Garbage collection de Map em mem√≥ria                |
| `src/lib/logger.ts`                                            | 54                     | Itera√ß√£o sobre Object.entries (sanitiza√ß√£o)         |
| `src/lib/log-sanitizer.ts`                                     | 101                    | Itera√ß√£o sobre Object.entries (sanitiza√ß√£o)         |
| `src/lib/config-cache.ts`                                      | 66, 71                 | Opera√ß√µes em Map local                              |
| `src/app/api/v1/dashboard/admin/route.ts`                      | 197, 286-289, 391, 412 | Itera√ß√£o sobre dados j√° carregados                  |
| `src/app/api/v1/supervisor/.../notification-settings/route.ts` | 230                    | Constru√ß√£o de array (sem await)                     |
| `src/components/contributions/hooks/usePaymentSync.ts`         | 150                    | While loop de retry (m√°x 3 tentativas, intencional) |

---

## Resumo por Severidade

| Severidade | Total | Corrigidos | Pendentes |
| ---------- | ----- | ---------- | --------- |
| üî¥ CR√çTICO | 2     | 2 ‚úÖ       | 0         |
| üü° ATEN√á√ÉO | 6     | 1 ‚úÖ       | 5         |
| **Total**  | **8** | **3**      | **5**     |

## Corre√ß√µes Aplicadas

| #   | Arquivo                      | Corre√ß√£o                                                                 |
| --- | ---------------------------- | ------------------------------------------------------------------------ |
| 1   | `send-reminders/route.ts`    | Dedup batch com `inArray()` + `NotificationService` √∫nico fora dos loops |
| 2   | `transacoes/export/route.ts` | 4 queries batch por role com `inArray()` + Map s√≠ncrono                  |
| 6   | `notification-hooks.ts`      | `NotificationService` movido para fora do loop de regras                 |

## Pendentes (arquiteturais)

| #   | Arquivo                                 | Motivo                                                |
| --- | --------------------------------------- | ----------------------------------------------------- |
| 3   | `bootstrap/route.ts`                    | Baixo impacto (5 itera√ß√µes fixas)                     |
| 4   | `notification-scheduler.ts` (welcome)   | Requer reestrutura√ß√£o do scheduler + falta `.limit()` |
| 5   | `notification-scheduler.ts` (reminders) | Requer reestrutura√ß√£o do scheduler + falta `.limit()` |
| 7   | `sns/webhook/route.ts`                  | Baixo impacto (1-3 destinat√°rios)                     |
| 8   | `cron/notifications/route.ts`           | Parcialmente otimizado, service por usu√°rio restante  |

### Problemas para o Relat√≥rio Final

| #   | Severidade | Descri√ß√£o                                                                        | Status       |
| --- | ---------- | -------------------------------------------------------------------------------- | ------------ |
| 1   | üî¥ CR√çTICO | N+1 em `send-reminders` ‚Äî dedup + service por usu√°rio                            | ‚úÖ CORRIGIDO |
| 2   | üî¥ CR√çTICO | N+1 em `transacoes/export` ‚Äî query de perfil por transa√ß√£o                       | ‚úÖ CORRIGIDO |
| 3   | üü° ATEN√á√ÉO | N+1 em `bootstrap` ‚Äî SELECT+INSERT por template/regra (5 fixas)                  | üü¢ SUGEST√ÉO  |
| 4   | üü° ATEN√á√ÉO | N+1 em `notification-scheduler` welcome ‚Äî settings por usu√°rio, sem `.limit()`   | üü¢ SUGEST√ÉO  |
| 5   | üü° ATEN√á√ÉO | N+1 em `notification-scheduler` reminders ‚Äî settings por usu√°rio, sem `.limit()` | üü¢ SUGEST√ÉO  |
| 6   | üü° ATEN√á√ÉO | N+1 em `notification-hooks` ‚Äî `NotificationService` recriado por regra           | ‚úÖ CORRIGIDO |
| 7   | üü° ATEN√á√ÉO | N+1 em `sns/webhook` ‚Äî SELECT+UPDATE/INSERT por destinat√°rio (1-3 t√≠pico)        | üü¢ SUGEST√ÉO  |
| 8   | üü° ATEN√á√ÉO | N+1 parcial em `cron/notifications` ‚Äî dedup otimizado, service por usu√°rio       | üü¢ SUGEST√ÉO  |
