# 6.1 ‚Äî Chamadas `fetch()` sem timeout (sem AbortController ou signal)

**Requisitos:** 4.1
**Propriedade 6:** Chamadas fetch devem ter timeout
**Data:** An√°lise est√°tica do c√≥digo-fonte
**√öltima revis√£o:** 2025-02-10

## Resumo

- **Total de chamadas `fetch()` encontradas:** ~55+
- **Com timeout (AbortController + signal):** ~35 (todas as chamadas a servi√ßos externos)
- **Sem timeout (client-side para APIs internas):** ~20 chamadas
- **Itens cr√≠ticos pendentes:** 0
- **Status:** ‚úÖ TODAS as chamadas a servi√ßos externos possuem timeout adequado

## ‚úÖ Chamadas COM timeout (AbortController configurado)

### Middleware e Auth

| #   | Arquivo                                         | Servi√ßo                                | Timeout |
| --- | ----------------------------------------------- | -------------------------------------- | ------- |
| 1   | `src/middleware.ts`                             | Interno (maintenance-check)            | 1s      |
| 2   | `src/app/auth/recuperar-senha/page.tsx`         | Interno (forgot-password)              | 10s     |
| 3   | `src/app/auth/redefinir-senha/[token]/page.tsx` | Interno (verify-token, reset-password) | 10s     |
| 4   | `src/app/auth/nova-conta/page.tsx`              | Interno (register, supervisores)       | 10-15s  |

### Cielo API (Pagamentos) ‚Äî ‚úÖ Todas com timeout 15s

| #   | Arquivo                                                   | Opera√ß√£o                                                                                         | Timeout |
| --- | --------------------------------------------------------- | ------------------------------------------------------------------------------------------------ | ------- |
| 1   | `src/lib/cielo.ts` ‚Äî `cieloFetch()` wrapper               | Todas as chamadas Cielo (createPix, createCreditCard, createBoleto, cancelPayment, queryPayment) | 15s     |
| 2   | `src/app/api/v1/supervisor/transacoes/[id]/sync/route.ts` | Sync status Cielo                                                                                | 15s     |
| 3   | `src/app/api/v1/supervisor/transacoes/[id]/route.ts`      | Consulta Cielo                                                                                   | 15s     |
| 4   | `src/app/api/v1/pastor/transacoes/[id]/route.ts`          | Consulta Cielo                                                                                   | 15s     |
| 5   | `src/app/api/v1/igreja/transacoes/[id]/route.ts`          | Consulta Cielo                                                                                   | 15s     |

**Implementa√ß√£o:** `cieloFetch()` em `src/lib/cielo.ts` usa AbortController com 15s de timeout como wrapper centralizado. As rotas de transa√ß√£o individuais tamb√©m possuem AbortController pr√≥prio com 15s.

### Evolution API (WhatsApp) ‚Äî ‚úÖ Todas com timeout 10s

| #   | Arquivo                                            | Opera√ß√£o                        | Timeout |
| --- | -------------------------------------------------- | ------------------------------- | ------- |
| 1   | `src/lib/notifications.ts` (WhatsAppService)       | Enviar mensagem WhatsApp        | 10s     |
| 2   | `src/app/api/v1/whatsapp/status/route.ts`          | Verificar status                | 10s     |
| 3   | `src/app/api/v1/whatsapp/restart/route.ts`         | Reiniciar inst√¢ncia             | 10s     |
| 4   | `src/app/api/v1/whatsapp/logout/route.ts`          | Logout inst√¢ncia                | 10s     |
| 5   | `src/app/api/v1/whatsapp/info/route.ts`            | Info inst√¢ncia + perfil         | 10s     |
| 6   | `src/app/api/v1/whatsapp/connectionState/route.ts` | Estado conex√£o                  | 10s     |
| 7   | `src/app/api/v1/whatsapp/connect/route.ts`         | Listar/criar/conectar inst√¢ncia | 10s     |
| 8   | `src/app/api/v1/whatsapp/instance/route.ts`        | CRUD inst√¢ncia                  | 10s     |
| 9   | `src/app/api/v1/settings/whatsapp/test/route.ts`   | Teste envio                     | 10s     |

### OpenAI API ‚Äî ‚úÖ Todas com timeout 30s

| #   | Arquivo                                        | Opera√ß√£o              | Timeout |
| --- | ---------------------------------------------- | --------------------- | ------- |
| 1   | `src/app/api/v1/test/openai/route.ts`          | Teste chave OpenAI    | 30s     |
| 2   | `src/app/api/v1/templates/ai-suggest/route.ts` | Sugest√£o IA templates | 30s     |
| 3   | `src/app/api/v1/dashboard/insights/route.ts`   | Insights dashboard    | 30s     |

### ViaCEP ‚Äî ‚úÖ Server-side com timeout 5s

| #   | Arquivo                       | Opera√ß√£o           | Timeout |
| --- | ----------------------------- | ------------------ | ------- |
| 1   | `src/app/api/v1/cep/route.ts` | Busca CEP (server) | 5s      |

### SNS Webhook ‚Äî ‚úÖ Com timeout 5s

| #   | Arquivo                               | Opera√ß√£o                   | Timeout |
| --- | ------------------------------------- | -------------------------- | ------- |
| 1   | `src/app/api/v1/sns/webhook/route.ts` | Confirma√ß√£o subscri√ß√£o SNS | 5s      |

## Timeouts aplicados por servi√ßo

| Servi√ßo       | Timeout | Status          |
| ------------- | ------- | --------------- |
| Cielo API     | 15s     | ‚úÖ Implementado |
| Evolution API | 10s     | ‚úÖ Implementado |
| OpenAI API    | 30s     | ‚úÖ Implementado |
| ViaCEP        | 5s      | ‚úÖ Implementado |
| SNS Subscribe | 5s      | ‚úÖ Implementado |

## üü¢ SUGEST√ÉO ‚Äî Chamadas client-side a APIs internas (sem timeout)

Estas chamadas s√£o feitas do browser para o pr√≥prio backend Next.js. O risco √© baixo pois:

- O servidor √© local (mesma infra)
- O browser j√° possui timeout nativo
- O Vercel imp√µe limite de 10s em serverless functions

N√£o √© necess√°rio corrigir, mas pode melhorar a UX com timeouts expl√≠citos para feedback ao usu√°rio.

### Hooks React

| #   | Arquivo                             | Endpoint                       |
| --- | ----------------------------------- | ------------------------------ |
| 1   | `src/hooks/use-upload.ts`           | `/api/v1/upload` (POST/DELETE) |
| 2   | `src/hooks/use-s3-config.ts`        | `/api/v1/settings/s3`          |
| 3   | `src/hooks/use-layout-data.ts`      | `/api/v1/layout-data`          |
| 4   | `src/hooks/use-company-settings.ts` | `/api/v1/company/public`       |

### Componentes

| #   | Arquivo                                                        | Endpoint                           |
| --- | -------------------------------------------------------------- | ---------------------------------- |
| 1   | `src/components/ui/send-message-dialog.tsx`                    | `/api/v1/send-message`             |
| 2   | `src/components/ui/quick-profile-modal.tsx`                    | `/api/v1/users/{id}/quick-profile` |
| 3   | `src/components/ui/fraud-alert.tsx`                            | `/api/v1/users/{id}/fraud-stats`   |
| 4   | `src/components/transaction-detail-page.tsx`                   | `{apiEndpoint}/{id}`               |
| 5   | `src/components/global-search.tsx`                             | `/api/v1/{role}/search`            |
| 6   | `src/components/contributions/forms/PaymentMethodSelector.tsx` | `/api/v1/payment-methods`          |
| 7   | `src/components/contributions/ContributionForm.tsx`            | `/api/v1/payment-methods`          |
| 8   | `src/components/contributions/hooks/usePaymentSync.ts`         | `/api/v1/transacoes/{id}`          |
| 9   | `src/components/contributions/hooks/useContribution.ts`        | `/api/v1/transacoes`               |

### P√°ginas (client-side)

| #   | Arquivo                                     | Nota                                  |
| --- | ------------------------------------------- | ------------------------------------- |
| 1   | `src/app/supervisor/perfil/page.tsx`        | ViaCEP client-side + endpoints perfil |
| 2   | `src/app/supervisor/transacoes/page.tsx`    | Listagem + sync + reenvio             |
| 3   | `src/app/supervisor/pastores/[id]/page.tsx` | M√∫ltiplos endpoints pastores          |

### Template de c√≥digo (n√£o executado)

| #   | Arquivo                          | Nota                                                                     |
| --- | -------------------------------- | ------------------------------------------------------------------------ |
| 1   | `src/lib/update-avatar-pages.ts` | Template string com fetch ‚Äî gerador de c√≥digo, n√£o executado diretamente |

## Conclus√£o

Todas as chamadas `fetch()` a servi√ßos externos (Cielo, Evolution API, OpenAI, ViaCEP, SNS) possuem timeout via AbortController com valores adequados para cada servi√ßo. Nenhuma corre√ß√£o de c√≥digo necess√°ria. As chamadas client-side a APIs internas s√£o de baixo risco e ficam como sugest√£o de melhoria futura.
