# 6.3 ‚Äî Opera√ß√µes Multi-Step sem Transa√ß√£o At√¥mica e Depend√™ncias sem Fallback

**Requisitos:** 4.3, 4.4
**√öltima revis√£o:** 2025-02-10

---

## Resumo

- **Itens cr√≠ticos pendentes:** 0
- **Corre√ß√µes aplicadas:** 9
- **Itens aceitos (n√£o corrig√≠veis):** 3 (envio externo + update DB ‚Äî n√£o pode ser at√¥mico)
- **Status:** ‚úÖ TODOS os itens corrig√≠veis foram corrigidos

---

## Parte A: Opera√ß√µes Multi-Step sem `db.transaction()`

### ‚úÖ Locais que J√Å usam transa√ß√£o corretamente (~35+ ocorr√™ncias)

O projeto usa `db.transaction()` consistentemente para cria√ß√£o de usu√°rios + perfis (admin, pastor, supervisor, manager, igreja) e para atualiza√ß√£o de notification-settings (delete + insert).

### ‚úÖ CORRIGIDO ‚Äî Opera√ß√µes multi-step agora com transa√ß√£o

#### 1. `src/app/api/v1/pastor/perfil/route.ts` (PUT) ‚Äî ‚úÖ CORRIGIDO

- **Problema original:** Atualizava `users` e `pastorProfiles` em duas opera√ß√µes separadas
- **Corre√ß√£o:** Envolvido em `db.transaction()` com `userId` extra√≠do antes do callback para evitar narrowing issue

#### 2. `src/app/api/v1/igreja/perfil/route.ts` (PUT) ‚Äî ‚úÖ CORRIGIDO

- **Problema original:** Atualizava `users` e `churchProfiles` separadamente
- **Corre√ß√£o:** Envolvido em `db.transaction()` com `userId` extra√≠do antes do callback

#### 3. `src/app/api/v1/sns/webhook/route.ts` ‚Äî `handleBounce()` ‚Äî ‚úÖ CORRIGIDO

- **Problema original:** Select + update/insert na `emailBlacklist` e insert em `notificationLogs` sem transa√ß√£o, por recipient
- **Corre√ß√£o:** Cada recipient agora √© processado dentro de `db.transaction()` at√¥mico (blacklist + log)

#### 4. `src/app/api/v1/sns/webhook/route.ts` ‚Äî `handleComplaint()` ‚Äî ‚úÖ CORRIGIDO

- **Problema original:** Mesmo padr√£o do handleBounce
- **Corre√ß√£o:** Cada recipient agora √© processado dentro de `db.transaction()` at√¥mico

#### 5. `src/app/api/v1/notification-rules/bootstrap/route.ts` (POST) ‚Äî ‚úÖ CORRIGIDO

- **Problema original:** Criava templates e regras em loop sem transa√ß√£o
- **Corre√ß√£o:** Todo o bloco de cria√ß√£o de templates + regras envolvido em `db.transaction()`

#### 6. `src/db/seed.ts` ‚Äî ‚úÖ CORRIGIDO

- **Problema original:** Deletava ~15 tabelas e inseria dados sem transa√ß√£o
- **Corre√ß√£o:** Todo o seed (deletes + inserts) envolvido em `db.transaction()`

### üü° ACEITO ‚Äî Opera√ß√µes com servi√ßo externo (n√£o podem ser at√¥micas)

Estas opera√ß√µes envolvem envio de notifica√ß√£o (email/WhatsApp) seguido de update no banco. N√£o √© poss√≠vel usar `db.transaction()` pois o servi√ßo externo n√£o participa da transa√ß√£o. O padr√£o atual (enviar ‚Üí marcar como enviado) √© o mais seguro poss√≠vel ‚Äî no pior caso, uma notifica√ß√£o √© reenviada, o que √© prefer√≠vel a nunca enviar.

#### 7. `src/app/api/v1/cron/notifications/route.ts` ‚Äî `processNewUsers()` ‚Äî üü° ACEITO

- **Padr√£o:** Envia notifica√ß√£o ‚Üí `db.update(users).set({ welcomeSent: true })`
- **Mitiga√ß√£o existente:** Dedup via `welcomeSent: false` no WHERE + limite de 50 usu√°rios por execu√ß√£o

#### 8. `src/app/api/v1/cron/notifications/route.ts` ‚Äî `processPayments/Reminders/Overdue()` ‚Äî üü° ACEITO

- **Padr√£o:** Envia notifica√ß√£o ‚Üí `db.insert(notificationLogs)`
- **Mitiga√ß√£o existente:** Dedup via batch query de `notificationLogs` com `inArray()` antes do loop + distributed lock Redis

#### 9. `src/lib/notification-scheduler.ts` ‚Äî `processWelcomeNotifications()` ‚Äî üü° ACEITO

- **Padr√£o:** Envia notifica√ß√£o ‚Üí `db.update(users).set({ welcomeSent: true })`
- **Mitiga√ß√£o existente:** Dedup via `shouldSendNotificationWithConfig()` antes do envio

### ‚úÖ OK ‚Äî Webhook Cielo (j√° adequado)

#### 10. `src/app/api/v1/webhooks/cielo/route.ts` ‚Äî ‚úÖ OK

- A reconcilia√ß√£o em si √© at√¥mica via `reconcileTransactionState()`
- O envio de email √© best-effort com try/catch separado
- Dedup de recibo via `notificationLogs` j√° implementado
- Tratamento adequado ‚Äî nenhuma corre√ß√£o necess√°ria

---

## Parte B: Depend√™ncias de Servi√ßos Externos sem Fallback

### ‚úÖ CORRIGIDO ‚Äî Redis em queues e worker

#### `src/lib/queues.ts` ‚Äî ‚úÖ CORRIGIDO

- **Problema original:** `new IORedis()` sem try/catch ‚Äî se Redis indispon√≠vel, crashava o m√≥dulo
- **Corre√ß√£o:** `createRedis()` retorna `IORedis | null` com try/catch. `notificationQueue` √© `Queue | null`. Consumidor `addNotificationJob()` em `notification-hooks.ts` verifica `if (!notificationQueue)` antes de usar

#### `src/workers/notification-worker.ts` ‚Äî ‚úÖ CORRIGIDO

- **Problema original:** Mesmo padr√£o ‚Äî Redis sem fallback
- **Corre√ß√£o:** `createRedis()` retorna `IORedis | null`. Worker s√≥ √© criado se `connection` n√£o for null. Se Redis indispon√≠vel, loga erro e n√£o crasheia

#### `src/lib/notification-hooks.ts` ‚Äî `addNotificationJob()` ‚Äî ‚úÖ CORRIGIDO

- **Problema original:** Chamava `notificationQueue.add()` sem verificar null
- **Corre√ß√£o:** Verifica `if (!notificationQueue)` e loga erro + retorna sem crashear

### ‚úÖ OK ‚Äî Servi√ßos j√° com fallback adequado

| Servi√ßo            | Arquivo                          | Status | Detalhes                                                            |
| ------------------ | -------------------------------- | ------ | ------------------------------------------------------------------- |
| Redis (cache)      | `src/lib/redis.ts`               | ‚úÖ OK  | Retorna `IORedis \| null`                                           |
| Redis (cache ops)  | `src/lib/cache.ts`               | ‚úÖ OK  | Verifica `if (!redis) return` em todas as fun√ß√µes                   |
| Redis (rate limit) | `src/lib/rate-limit.ts`          | ‚úÖ OK  | Se Redis cair, permite todas as requisi√ß√µes (degrada√ß√£o graciosa)   |
| S3                 | `src/lib/s3-client.ts`           | ‚úÖ OK  | Verifica `if (!this.client)` antes de cada opera√ß√£o                 |
| S3 (upload)        | `src/app/api/v1/upload/route.ts` | ‚úÖ OK  | Try/catch com mensagem amig√°vel                                     |
| Cielo API          | `src/lib/cielo.ts`               | ‚úÖ OK  | Erros propagados com mensagens descritivas, 404 tratado             |
| WhatsApp           | `src/lib/notifications.ts`       | ‚úÖ OK  | Retorna `false` em caso de falha, n√£o crasheia                      |
| Email (SES/SMTP)   | `src/lib/notifications.ts`       | ‚úÖ OK  | Fallback SES‚ÜíSMTP, verifica blacklist, retorna `{ success: false }` |

---

## Resumo Final

| Categoria                | Total  | Corrigidos | Aceitos | OK    |
| ------------------------ | ------ | ---------- | ------- | ----- |
| Multi-step sem transa√ß√£o | 10     | 6          | 3       | 1     |
| Redis sem fallback       | 3      | 3          | ‚Äî       | ‚Äî     |
| Servi√ßos com fallback    | 7      | ‚Äî          | ‚Äî       | 7     |
| **Total**                | **20** | **9**      | **3**   | **8** |
