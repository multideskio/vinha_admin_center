# 1.2 ‚Äî Rotas API sem Valida√ß√£o Zod (POST/PUT/PATCH)

**Data:** 2025-01-20
**Requisito:** 2.3 ‚Äî Endpoints que recebem dados de entrada sem Valida√ß√£o Zod
**Propriedade:** 2 ‚Äî Rotas com entrada de dados devem ter valida√ß√£o Zod

## Resumo

| M√©trica                                     | Valor                           |
| ------------------------------------------- | ------------------------------- |
| Total de rotas com POST/PUT/PATCH           | 59                              |
| Rotas COM valida√ß√£o Zod                     | 55 (93,2%)                      |
| Rotas SEM valida√ß√£o Zod (sem body)          | 4 (6,8%) ‚Äî falsos positivos     |
| üî¥ Rotas que precisavam de Zod e N√ÉO tinham | 0 ‚úÖ (8 corrigidas na Task 9.3) |

---

## ‚úÖ Rotas Corrigidas (anteriormente sem Zod)

### 1. `src/app/api/v1/webhooks/cielo/route.ts` ‚Äî CORRIGIDO ‚úÖ

- **Severidade original:** üî¥ CR√çTICO
- **Problema:** Webhook financeiro processava `PaymentId` e `ChangeType` sem valida√ß√£o.
- **Corre√ß√£o aplicada (Task 9.3):**
  - Schema `cieloWebhookSchema`: `z.object({ PaymentId: z.string().uuid(), ChangeType: z.number().int().min(1).max(6) })`
  - Usa `.safeParse()` com tratamento de erro via `ValidationError`
  - Retorna 200 com mensagem de skip para payloads inv√°lidos (padr√£o Cielo)

### 2. `src/app/api/v1/igreja/perfil/route.ts` (PUT) ‚Äî CORRIGIDO ‚úÖ

- **Severidade original:** üü° ATEN√á√ÉO
- **Problema:** Spread `...profileData` sem valida√ß√£o permitia inje√ß√£o de campos.
- **Corre√ß√£o aplicada (Task 9.3):**
  - Schema `churchProfileUpdateSchema` com campos tipados (`email`, `phone`, `titheDay`, `avatarUrl`, redes sociais, `foundationDate`, `newPassword`)
  - Usa `.safeParse()` com retorno 400 para dados inv√°lidos
  - `.passthrough()` para campos extras do perfil da igreja

### 3. `src/app/api/v1/pastor/perfil/route.ts` (PUT) ‚Äî CORRIGIDO ‚úÖ

- **Severidade original:** üü° ATEN√á√ÉO
- **Problema:** Spread `...profileData` sem valida√ß√£o permitia inje√ß√£o de campos.
- **Corre√ß√£o aplicada (Task 9.3):**
  - Schema `pastorProfileUpdateSchema` com campos tipados (`email`, `phone`, `titheDay`, `avatarUrl`, redes sociais, `birthDate`, `street`, `newPassword`)
  - Usa `.safeParse()` com retorno 400 para dados inv√°lidos
  - `.passthrough()` para campos extras do perfil do pastor

### 4. `src/app/api/v1/templates/ai-suggest/route.ts` (POST) ‚Äî CORRIGIDO ‚úÖ

- **Severidade original:** üü° ATEN√á√ÉO
- **Problema:** Dados usados para construir prompt OpenAI sem valida√ß√£o ‚Äî risco de prompt injection.
- **Corre√ß√£o aplicada (Task 9.3):**
  - Schema `aiSuggestSchema`: `z.object({ eventTrigger: z.enum([...]), daysOffset: z.number().int().optional(), variables: z.array(z.string()).optional(), tone: z.string().optional() })`
  - `eventTrigger` validado como enum restrito
  - Usa `.safeParse()` com retorno 400 para dados inv√°lidos

### 5. `src/app/api/v1/settings/openai/route.ts` (PUT) ‚Äî CORRIGIDO ‚úÖ

- **Severidade original:** üü° ATEN√á√ÉO
- **Problema:** Armazenava API key com valida√ß√£o manual (`typeof !== 'string'`).
- **Corre√ß√£o aplicada (Task 9.3):**
  - Schema `openaiSettingsSchema`: `z.object({ openaiApiKey: z.string().min(1) })`
  - Usa `.safeParse()` com retorno 400 para dados inv√°lidos

### 6. `src/app/api/auth/forgot-password/route.ts` (POST) ‚Äî CORRIGIDO ‚úÖ

- **Severidade original:** üü° ATEN√á√ÉO
- **Problema:** Valida√ß√£o manual m√≠nima (`if (!email)`) sem verificar formato.
- **Corre√ß√£o aplicada (Task 9.3):**
  - Schema `forgotPasswordSchema`: `z.object({ email: z.string().email() })`
  - Usa `.safeParse()` com retorno 400 para dados inv√°lidos

### 7. `src/app/api/auth/reset-password/route.ts` (POST) ‚Äî CORRIGIDO ‚úÖ

- **Severidade original:** üü° ATEN√á√ÉO
- **Problema:** Valida√ß√£o manual (`if (!token || !password)` e `password.length < 8`).
- **Corre√ß√£o aplicada (Task 9.3):**
  - Schema `resetPasswordSchema`: `z.object({ token: z.string().min(1), password: z.string().min(8) })`
  - Usa `.safeParse()` com retorno 400 para dados inv√°lidos

### 8. `src/app/api/evolution/webhook/route.ts` (POST) ‚Äî CORRIGIDO ‚úÖ

- **Severidade original:** üü° ATEN√á√ÉO
- **Problema:** Cast direto para `EvolutionWebhookData` sem valida√ß√£o runtime.
- **Corre√ß√£o aplicada (Task 9.3):**
  - Schema `evolutionWebhookSchema` com valida√ß√£o de `event`, `instance` e estrutura de `data`
  - Usa `.safeParse()` com retorno 400 e log `console.warn` para payloads inv√°lidos

---

## Rotas que N√ÉO Precisam de Zod (falsos positivos)

| #   | Rota                                                          | Motivo                                   |
| --- | ------------------------------------------------------------- | ---------------------------------------- |
| 1   | `src/app/api/cron/notifications/route.ts` (POST)              | Alias para GET, n√£o processa body        |
| 2   | `src/app/api/v1/admin/send-reminders/route.ts` (POST)         | N√£o recebe body (trigger sem par√¢metros) |
| 3   | `src/app/api/v1/manager/gerentes/route.ts` (POST)             | Rota deprecada, retorna 410 Gone         |
| 4   | `src/app/api/v1/notification-rules/bootstrap/route.ts` (POST) | N√£o recebe body (bootstrap autom√°tico)   |

---

## Rotas P√∫blicas Leg√≠timas (sem auth ‚Äî correto)

| #   | Rota                                           | Justificativa                                             |
| --- | ---------------------------------------------- | --------------------------------------------------------- |
| 1   | `src/app/api/health/route.ts`                  | Health check ‚Äî deve ser p√∫blico                           |
| 2   | `src/app/api/auth/forgot-password/route.ts`    | Recupera√ß√£o de senha ‚Äî p√∫blico com rate limit ‚úÖ          |
| 3   | `src/app/api/auth/reset-password/route.ts`     | Redefini√ß√£o de senha ‚Äî p√∫blico com rate limit ‚úÖ          |
| 4   | `src/app/api/auth/verify-token/route.ts`       | Verifica√ß√£o de token de reset ‚Äî p√∫blico                   |
| 5   | `src/app/api/evolution/webhook/route.ts`       | Webhook Evolution API ‚Äî p√∫blico (recebe eventos externos) |
| 6   | `src/app/api/v1/auth/login/route.ts`           | Login ‚Äî p√∫blico com rate limit ‚úÖ                         |
| 7   | `src/app/api/v1/auth/register/church/route.ts` | Registro de igreja ‚Äî p√∫blico com rate limit ‚úÖ            |
| 8   | `src/app/api/v1/auth/register/pastor/route.ts` | Registro de pastor ‚Äî p√∫blico com rate limit ‚úÖ            |
| 9   | `src/app/api/v1/cep/route.ts`                  | Consulta ViaCEP ‚Äî p√∫blico (utilit√°rio)                    |
| 10  | `src/app/api/v1/company/public/route.ts`       | Dados p√∫blicos da empresa ‚Äî p√∫blico por design            |
| 11  | `src/app/api/v1/maintenance-check/route.ts`    | Verifica√ß√£o de manuten√ß√£o ‚Äî p√∫blico                       |
| 12  | `src/app/api/v1/sns/webhook/route.ts`          | Webhook AWS SNS ‚Äî p√∫blico (valida assinatura SNS) ‚úÖ      |
| 13  | `src/app/api/v1/webhooks/cielo/route.ts`       | Webhook Cielo ‚Äî p√∫blico (recebe eventos de pagamento)     |
| 14  | `src/app/api/cron/notifications/route.ts`      | Cron job ‚Äî autenticado via CRON_SECRET (timing-safe) ‚úÖ   |
| 15  | `src/app/api/v1/cron/notifications/route.ts`   | Cron job ‚Äî autenticado via CRON_SECRET                    |

---

## Conclus√£o

Todas as 8 rotas que precisavam de valida√ß√£o Zod foram corrigidas na Task 9.3. A taxa de conformidade √© agora **55/55 = 100%** (excluindo rotas sem body). Cada rota usa `.safeParse()` com retorno 400 estruturado para dados inv√°lidos.
