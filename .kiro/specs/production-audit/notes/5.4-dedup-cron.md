# 5.4 ‚Äî Notifica√ß√µes sem Deduplica√ß√£o e Cron Jobs sem Prote√ß√£o de Execu√ß√£o Paralela

**Requisitos:** 3.4 (envio sem deduplica√ß√£o), 3.5 (cron jobs sem prote√ß√£o paralela)
**√öltima verifica√ß√£o:** 10/02/2026

---

## Resumo

O sistema possui um m√≥dulo de deduplica√ß√£o (`notification-dedup.ts`) bem implementado. Ap√≥s as corre√ß√µes, ele agora √© utilizado em **todos os pontos cr√≠ticos de envio**. Os cron jobs agora possuem **distributed lock via Redis** para prevenir execu√ß√£o paralela.

---

## 1. An√°lise de Deduplica√ß√£o de Notifica√ß√µes

### ‚úÖ Pontos COM deduplica√ß√£o

| Arquivo                                  | Fun√ß√£o                          | Tipo                           | Status        |
| ---------------------------------------- | ------------------------------- | ------------------------------ | ------------- |
| `src/lib/notification-hooks.ts`          | `onUserCreated()`               | `welcome_email`                | ‚úÖ J√° existia |
| `src/lib/notification-hooks.ts`          | `onTransactionCreated()`        | `payment_confirmation`         | ‚úÖ J√° existia |
| `src/lib/notification-hooks.ts`          | `onTransactionFailed()`         | `payment_failed`               | ‚úÖ J√° existia |
| `src/lib/notification-hooks.ts`          | `onUserDeleted()`               | `account_deleted_notification` | ‚úÖ J√° existia |
| `src/lib/notification-hooks.ts`          | `processNotificationEvent()`    | Mapeado por `eventType`        | ‚úÖ J√° existia |
| `src/lib/notification-scheduler.ts`      | `processWelcomeNotifications()` | `welcome_email`                | ‚úÖ CORRIGIDO  |
| `src/lib/notification-scheduler.ts`      | `processPaymentReminders()`     | `tithe_reminder`               | ‚úÖ CORRIGIDO  |
| `src/app/api/v1/webhooks/cielo/route.ts` | Email de recibo                 | `receipt_{transactionId}`      | ‚úÖ CORRIGIDO  |

### Achados de Deduplica√ß√£o

#### 1.1 `src/lib/notification-scheduler.ts` ‚Äî `processWelcomeNotifications()`

**Status:** ‚úÖ CORRIGIDO

**Corre√ß√£o:** Adicionado `shouldSendNotificationWithConfig(user.id, 'welcome_email')` antes do envio. Agora usa o m√≥dulo centralizado de dedup al√©m da flag `welcomeSent`.

---

#### 1.2 `src/lib/notification-scheduler.ts` ‚Äî `processPaymentReminders()`

**Status:** ‚úÖ CORRIGIDO

**Corre√ß√£o:** Adicionado `shouldSendNotificationWithConfig(user.id, 'tithe_reminder')` antes do envio. Previne envio duplicado se o cron executar m√∫ltiplas vezes no mesmo dia.

---

#### 1.3 `src/app/api/v1/cron/notifications/route.ts` ‚Äî `processNewUsers()`

**Status:** ‚ö†Ô∏è PARCIALMENTE MITIGADO

**Detalhes:** Usa flag `welcomeSent` para evitar reenvio + agora protegido por distributed lock (achado 2.2). A race condition entre duas inst√¢ncias paralelas est√° resolvida pelo lock. N√£o usa o m√≥dulo `notification-dedup.ts`, mas a combina√ß√£o de `welcomeSent` + lock √© suficiente.

---

#### 1.4-1.6 `src/app/api/v1/cron/notifications/route.ts` ‚Äî `processPayments/Reminders/Overdue()`

**Status:** ‚ö†Ô∏è PARCIALMENTE MITIGADO (aceit√°vel)

**Detalhes:** Implementam deduplica√ß√£o pr√≥pria via `notificationLogs` com `inArray` batch. N√£o usam o m√≥dulo `notification-dedup.ts`, mas a l√≥gica √© equivalente e eficiente. Agora protegidos por distributed lock contra execu√ß√£o paralela.

**Decis√£o:** Manter como est√° ‚Äî a dedup pr√≥pria funciona bem e o lock previne race conditions. Migrar para `shouldSendNotificationWithConfig()` seria inconsistente porque esse m√≥dulo faz query individual por usu√°rio, enquanto o padr√£o atual faz batch.

---

#### 1.7 `src/app/api/v1/webhooks/cielo/route.ts` ‚Äî Email de recibo

**Status:** ‚úÖ CORRIGIDO

**Corre√ß√£o:** Adicionada verifica√ß√£o de dedup via `notificationLogs` com `notificationType: receipt_{transactionId}` antes de enviar o email. Se a Cielo retentar o webhook, o recibo n√£o ser√° enviado novamente. Ap√≥s envio bem-sucedido, registra no `notificationLogs` para dedup futura.

---

#### 1.8 `src/lib/email.ts` ‚Äî `sendEmail()`

**Status:** üü¢ SUGEST√ÉO (sem altera√ß√£o)

**Detalhes:** Fun√ß√£o gen√©rica de envio ‚Äî a deduplica√ß√£o deve ser responsabilidade do chamador. Todos os chamadores cr√≠ticos agora t√™m dedup.

---

#### 1.9 `src/app/api/v1/send-message/route.ts` ‚Äî Envio manual

**Status:** üü¢ SUGEST√ÉO (sem altera√ß√£o)

**Detalhes:** A√ß√£o intencional do admin. J√° protegida por auth JWT + role admin. Dedup n√£o √© necess√°ria para envio manual.

---

#### 1.10 `src/app/api/v1/test/smoke/route.ts` ‚Äî Smoke test

**Status:** üü¢ SUGEST√ÉO (sem altera√ß√£o)

**Detalhes:** J√° possui par√¢metro `dryRun` para preview sem envio. Protegida por auth JWT + role admin. Rota de teste, baixo risco.

---

## 2. An√°lise de Cron Jobs ‚Äî Prote√ß√£o de Execu√ß√£o Paralela

#### 2.1 `src/app/api/cron/notifications/route.ts` ‚Äî Distributed lock

**Status:** ‚úÖ CORRIGIDO

**Corre√ß√£o:** Implementado distributed lock via Redis `SET NX` com TTL de 120s. Se outra inst√¢ncia j√° estiver executando, retorna `{ skipped: true }` sem processar. Lock √© liberado no `finally` block (mesmo em caso de erro). Tamb√©m removido o handler `POST` duplicado que redirecionava para `GET`.

---

#### 2.2 `src/app/api/v1/cron/notifications/route.ts` ‚Äî Distributed lock

**Status:** ‚úÖ CORRIGIDO

**Corre√ß√£o:** Implementado distributed lock via Redis `SET NX` com TTL de 120s (chave diferente: `cron:v1:notifications:lock`). Lock √© liberado no `finally` block. Rate limit mantido como camada adicional de prote√ß√£o.

---

#### 2.3 `src/app/api/v1/cron/notifications/route.ts` ‚Äî CRON_SECRET

**Status:** ‚úÖ J√Å CORRIGIDO (corre√ß√£o anterior)

**Detalhes:** J√° usa `env.CRON_SECRET` sem fallback hardcoded. Retorna 503 se n√£o configurado.

---

#### 2.4 Dois cron jobs duplicados para notifica√ß√µes

**Status:** üü° ATEN√á√ÉO (sem altera√ß√£o)

**Detalhes:** Existem dois endpoints:

- `api/cron/notifications` ‚Äî executa `runNotificationScheduler()` (welcome + payment reminders)
- `api/v1/cron/notifications` ‚Äî executa regras de notifica√ß√£o (user_registered, payment_received, etc.)

Ambos agora t√™m distributed lock com chaves diferentes, ent√£o n√£o interferem entre si. Mas se ambos estiverem ativos no scheduler, haver√° processamento duplicado de boas-vindas.

**Sugest√£o:** Consolidar em um √∫nico endpoint ou garantir que apenas um esteja ativo no cron scheduler.

---

#### 2.5 `runNotificationScheduler()` sem prote√ß√£o

**Status:** ‚úÖ CORRIGIDO (via achado 2.1)

**Detalhes:** O lock distribu√≠do no endpoint `api/cron/notifications` protege a execu√ß√£o de `runNotificationScheduler()`. Al√©m disso, o scheduler agora usa `shouldSendNotificationWithConfig()` para dedup (achados 1.1 e 1.2).

---

## 3. Resumo de Achados

| #   | Severidade  | Categoria | Descri√ß√£o                                                   | Status                           |
| --- | ----------- | --------- | ----------------------------------------------------------- | -------------------------------- |
| 1   | üî¥ CR√çTICO  | Cron      | Cron `api/cron/notifications` sem distributed lock          | ‚úÖ CORRIGIDO                     |
| 2   | üî¥ CR√çTICO  | Cron      | Cron `api/v1/cron/notifications` sem distributed lock       | ‚úÖ CORRIGIDO                     |
| 3   | üî¥ CR√çTICO  | Seguran√ßa | CRON_SECRET com fallback hardcoded                          | ‚úÖ J√Å CORRIGIDO                  |
| 4   | üü° ATEN√á√ÉO  | Dedup     | `notification-scheduler.ts` ‚Äî welcome sem dedup             | ‚úÖ CORRIGIDO                     |
| 5   | üü° ATEN√á√ÉO  | Dedup     | `notification-scheduler.ts` ‚Äî reminders sem dedup           | ‚úÖ CORRIGIDO                     |
| 6   | üü° ATEN√á√ÉO  | Dedup     | Cron v1 `processNewUsers()` ‚Äî usa apenas flag `welcomeSent` | ‚ö†Ô∏è Mitigado (lock)               |
| 7   | üü° ATEN√á√ÉO  | Dedup     | Webhook Cielo ‚Äî email de recibo sem dedup                   | ‚úÖ CORRIGIDO                     |
| 8   | üü° ATEN√á√ÉO  | Cron      | Dois endpoints de cron duplicados                           | üü¢ SUGEST√ÉO                      |
| 9   | üü° ATEN√á√ÉO  | Dedup     | Cron v1 dedup pr√≥pria inconsistente                         | ‚ö†Ô∏è Mitigado (lock + dedup batch) |
| 10  | üü¢ SUGEST√ÉO | Dedup     | `email.ts` ‚Äî sendEmail sem dedup embutida                   | üü¢ SUGEST√ÉO                      |
| 11  | üü¢ SUGEST√ÉO | Dedup     | `send-message` ‚Äî envio manual sem rate limit                | üü¢ SUGEST√ÉO                      |
| 12  | üü¢ SUGEST√ÉO | Dedup     | `smoke/route.ts` ‚Äî teste sem dedup                          | üü¢ SUGEST√ÉO                      |

## Corre√ß√µes Aplicadas

| #   | Arquivo                                      | Corre√ß√£o                                                         |
| --- | -------------------------------------------- | ---------------------------------------------------------------- |
| 1   | `src/app/api/cron/notifications/route.ts`    | Distributed lock Redis SET NX + TTL 120s + removido POST handler |
| 2   | `src/app/api/v1/cron/notifications/route.ts` | Distributed lock Redis SET NX + TTL 120s                         |
| 4   | `src/lib/notification-scheduler.ts`          | `shouldSendNotificationWithConfig()` em welcome                  |
| 5   | `src/lib/notification-scheduler.ts`          | `shouldSendNotificationWithConfig()` em reminders                |
| 7   | `src/app/api/v1/webhooks/cielo/route.ts`     | Dedup via `notificationLogs` + registro p√≥s-envio                |

### Problemas para o Relat√≥rio Final

| #   | Severidade  | Descri√ß√£o                           | Status             |
| --- | ----------- | ----------------------------------- | ------------------ |
| 1   | üî¥ CR√çTICO  | Cron scheduler sem distributed lock | ‚úÖ CORRIGIDO       |
| 2   | üî¥ CR√çTICO  | Cron v1 sem distributed lock        | ‚úÖ CORRIGIDO       |
| 3   | üî¥ CR√çTICO  | CRON_SECRET com fallback hardcoded  | ‚úÖ J√Å CORRIGIDO    |
| 4   | üü° ATEN√á√ÉO  | Scheduler welcome sem dedup         | ‚úÖ CORRIGIDO       |
| 5   | üü° ATEN√á√ÉO  | Scheduler reminders sem dedup       | ‚úÖ CORRIGIDO       |
| 6   | üü° ATEN√á√ÉO  | processNewUsers dedup parcial       | ‚ö†Ô∏è Mitigado (lock) |
| 7   | üü° ATEN√á√ÉO  | Webhook Cielo recibo sem dedup      | ‚úÖ CORRIGIDO       |
| 8   | üü° ATEN√á√ÉO  | Dois cron endpoints duplicados      | üü¢ SUGEST√ÉO        |
| 9   | üü° ATEN√á√ÉO  | Cron v1 dedup inconsistente         | ‚ö†Ô∏è Mitigado        |
| 10  | üü¢ SUGEST√ÉO | sendEmail sem dedup embutida        | üü¢ SUGEST√ÉO        |
| 11  | üü¢ SUGEST√ÉO | send-message sem rate limit         | üü¢ SUGEST√ÉO        |
| 12  | üü¢ SUGEST√ÉO | smoke test sem dedup                | üü¢ SUGEST√ÉO        |
