# 2.2 ‚Äî Secrets Hardcoded no C√≥digo

**Data:** 2025-01-28
**Requisito:** 2.2 ‚Äî Identificar secrets hardcoded no c√≥digo-fonte
**Status:** ‚úÖ Todos os 7 achados corrigidos
**√öltima atualiza√ß√£o:** Corre√ß√µes aplicadas

---

## Resumo

An√°lise de secrets hardcoded no c√≥digo-fonte. Encontrados **7 achados** (2 cr√≠ticos, 3 aten√ß√£o, 2 sugest√µes). Todos corrigidos.

## Achados

| #   | Arquivo                                      | Sev. | Descri√ß√£o                             | Status                                                          |
| --- | -------------------------------------------- | ---- | ------------------------------------- | --------------------------------------------------------------- |
| 1   | `src/lib/jwt.ts`                             | üî¥   | `JWT_SECRET` fallback hardcoded       | ‚úÖ Usa `env.JWT_SECRET` (m√≠n. 32 chars)                         |
| 2   | `src/app/api/v1/cron/notifications/route.ts` | üî¥   | `CRON_SECRET` fallback hardcoded      | ‚úÖ Adicionado ao `env.ts`, rota usa `env.CRON_SECRET` com guard |
| 3   | `src/lib/redis.ts`                           | üü°   | `REDIS_URL` via `process.env` direto  | ‚úÖ Usa `env.REDIS_URL` centralizado                             |
| 4   | `src/lib/queues.ts`                          | üü°   | `REDIS_URL` via `process.env` direto  | ‚úÖ Usa `env.REDIS_URL` centralizado                             |
| 5   | `src/workers/notification-worker.ts`         | üü°   | `REDIS_URL` via `process.env` direto  | ‚úÖ Usa `env.REDIS_URL` centralizado                             |
| 6   | `register/pastor/route.ts`                   | üü¢   | `Math.random()` para senha tempor√°ria | ‚úÖ Usa `crypto.randomBytes(12)`                                 |
| 7   | `register/church/route.ts`                   | üü¢   | `Math.random()` para senha tempor√°ria | ‚úÖ Usa `crypto.randomBytes(12)`                                 |

## Detalhes das Corre√ß√µes

### #1 ‚Äî JWT_SECRET (CR√çTICO) ‚úÖ

```typescript
// ‚ùå ANTES
const JWT_SECRET = new TextEncoder().encode(
  process.env.JWT_SECRET || 'your-super-secret-jwt-key-change-this-in-production',
)

// ‚úÖ DEPOIS ‚Äî validado via env.ts (m√≠nimo 32 caracteres)
import { env } from '@/lib/env'
const JWT_SECRET = new TextEncoder().encode(env.JWT_SECRET)
```

### #2 ‚Äî CRON_SECRET (CR√çTICO) ‚úÖ

Duas mudan√ßas:

1. `CRON_SECRET` adicionado ao schema Zod em `src/lib/env.ts` (opcional, m√≠n. 16 chars)
2. Rota usa `env.CRON_SECRET` com guard que retorna 503 se n√£o configurado

```typescript
// ‚ùå ANTES
const CRON_SECRET = process.env.CRON_SECRET || 'change-me-in-production'

// ‚úÖ DEPOIS
import { env } from '@/lib/env'
const CRON_SECRET = env.CRON_SECRET

export async function GET(request: Request) {
  if (!CRON_SECRET) {
    console.error('[CRON] CRON_SECRET n√£o configurado')
    return NextResponse.json({ error: 'Cron n√£o configurado' }, { status: 503 })
  }
  // ...
}
```

### #3, #4, #5 ‚Äî REDIS_URL centralizado ‚úÖ

Os 3 arquivos (`redis.ts`, `queues.ts`, `notification-worker.ts`) agora importam `env` de `@/lib/env` e usam `env.REDIS_URL` em vez de `process.env.REDIS_URL || 'redis://localhost:6379'`.

O default `redis://localhost:6379` continua existindo, mas centralizado no schema Zod do `env.ts`.

### #6, #7 ‚Äî Senhas tempor√°rias criptograficamente seguras ‚úÖ

```typescript
// ‚ùå ANTES ‚Äî PRNG previs√≠vel
const tempPassword =
  Math.random().toString(36).slice(-8) + Math.random().toString(36).slice(-8).toUpperCase()

// ‚úÖ DEPOIS ‚Äî criptograficamente seguro
import { randomBytes } from 'crypto'
const tempPassword = randomBytes(12).toString('base64url')
```

---

## Observa√ß√µes Positivas

- ‚úÖ `.env` est√° no `.gitignore`, prevenindo commit acidental de secrets
- ‚úÖ `env.ts` valida `JWT_SECRET`, `DATABASE_URL`, `COMPANY_INIT`, `ADMIN_INIT`, `DEFAULT_PASSWORD` e agora `CRON_SECRET`
- ‚úÖ Credenciais da Cielo API s√£o armazenadas no banco de dados, n√£o no c√≥digo
- ‚úÖ `.env.example` cont√©m apenas placeholders, n√£o valores reais

## Resumo de Severidade

| Severidade  | Quantidade | Corrigidos |
| ----------- | ---------- | ---------- |
| üî¥ CR√çTICO  | 2          | ‚úÖ 2/2     |
| üü° ATEN√á√ÉO  | 3          | ‚úÖ 3/3     |
| üü¢ SUGEST√ÉO | 2          | ‚úÖ 2/2     |
| **Total**   | **7**      | **‚úÖ 7/7** |
