name: Deploy Production

# Workflow acionado em pushes para a branch main
on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite executar manualmente

# Permiss√µes necess√°rias
permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    timeout-minutes: 5 # Timeout do job

    steps:
      # Checkout do c√≥digo
      - name: Check out code
        uses: actions/checkout@v4.2.2

      # Enviar notifica√ß√£o para o servidor de deployment
      - name: Trigger Deployment
        run: |
          echo "üöÄ Iniciando deployment..."
          echo "üì¶ Branch: ${{ github.ref_name }}"
          echo "üìù Commit: ${{ github.sha }}"
          
          # Fazer requisi√ß√£o com tratamento de erro
          RESPONSE=$(curl -X POST \
            --max-time 30 \
            --retry 3 \
            --retry-delay 2 \
            -w "\nHTTP_CODE:%{http_code}" \
            -f \
            -v \
            "http://178.156.141.41:3000/api/deploy/38223dbc644aa26b29c8bd889e04bc7c9c37c4b037f9e0d4" \
            2>&1)
          
          EXIT_CODE=$?
          
          echo "üìÑ Resposta completa:"
          echo "$RESPONSE"
          
          # Extrair HTTP code
          HTTP_CODE=$(echo "$RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
          
          # Verificar sucesso
          if [ $EXIT_CODE -eq 0 ] && [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ Deployment acionado com sucesso! (HTTP $HTTP_CODE)"
            exit 0
          else
            echo "‚ùå Falha ao acionar deployment! (Exit: $EXIT_CODE, HTTP: $HTTP_CODE)"
            exit 1
          fi

      # Confirma√ß√£o final
      - name: Deployment Status
        if: success()
        run: |
          echo "‚úÖ Workflow de deployment conclu√≠do com sucesso!"
          echo "‚è∞ Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"