# Vinha Admin Center - Cursor AI Rules & Context

## ğŸ“‹ VisÃ£o Geral do Projeto

Sistema de administraÃ§Ã£o para gestÃ£o de igrejas desenvolvido com Next.js 15, TypeScript, Drizzle ORM e PostgreSQL.

**Stack Principal:**
- Next.js 15.5.3 (App Router)
- TypeScript 5 (strict mode)
- Drizzle ORM 0.44.7
- PostgreSQL
- Lucia Auth / JWT (em migraÃ§Ã£o)
- AWS S3/SES
- Cielo Payment Gateway
- WhatsApp Integration (Evolution API)
- BullMQ + Redis (notificaÃ§Ãµes)

---

## ğŸ”´ BUGS CRÃTICOS CONHECIDOS (PRIORIDADE MÃXIMA)

**Status Geral:** 4/4 bugs crÃ­ticos resolvidos (100%) ğŸ‰  
**Ãšltima atualizaÃ§Ã£o:** 2025-11-05

### 1. âœ… ConfiguraÃ§Ã£o de Build Insegura (RESOLVIDO)
**Arquivo:** `next.config.ts`
**Status:** âœ… RESOLVIDO em 2025-11-05

```typescript
// âœ… CORRIGIDO
typescript: {
  ignoreBuildErrors: false,  // âœ… Validar tipos
},
eslint: {
  ignoreDuringBuilds: false, // âœ… Validar lint
},
```

**CorreÃ§Ã£o Aplicada:** Build agora valida tipos e lint corretamente  
**Resolvido por:** Cursor AI  
**Data:** 2025-11-05

---

### 2. âœ… DuplicaÃ§Ã£o de Sistema de AutenticaÃ§Ã£o (RESOLVIDO)
**Arquivos:** `src/lib/auth.ts` (removido) + `src/lib/jwt.ts` (mantido)
**Status:** âœ… RESOLVIDO em 2025-11-05

**CorreÃ§Ã£o Aplicada:**
- Removido `src/lib/auth.ts` (Lucia)
- Removido dependÃªncias `lucia` e `@lucia-auth/adapter-drizzle`
- Sistema unificado usando apenas JWT (`src/lib/jwt.ts`)
- Tabela `sessions` mantida para tracking opcional

**BenefÃ­cios:**
- Sistema Ãºnico e consistente
- Melhor performance (stateless)
- Menos dependÃªncias para manter

**Resolvido por:** Cursor AI  
**Data:** 2025-11-05  
**Regra:** Usar sempre `validateRequest` de `@/lib/jwt`

---

### 3. âœ… Middleware com API IncompatÃ­vel (RESOLVIDO)
**Arquivo:** `src/middleware.ts` linha 36-59
**Status:** âœ… RESOLVIDO em 2025-11-05

```typescript
// âœ… CORRIGIDO
const controller = new AbortController()
const timeoutId = setTimeout(() => controller.abort(), 1000)
try {
  const maintenanceCheck = await fetch(..., { signal: controller.signal })
  clearTimeout(timeoutId)
  // ...
} catch (error) {
  clearTimeout(timeoutId)
}
```

**CorreÃ§Ã£o Aplicada:** Usando AbortController compatÃ­vel com Edge Runtime  
**Resolvido por:** Cursor AI  
**Data:** 2025-11-05  
**Regra:** Nunca usar AbortSignal.timeout() em middleware Next.js

---

### 4. âœ… API de Maintenance Mode Quebrada (RESOLVIDO)
**Arquivo:** `src/app/api/v1/maintenance-check/route.ts`
**Status:** âœ… RESOLVIDO em 2025-11-05

```typescript
// âœ… CORRIGIDO
const [company] = await db
  .select({ maintenanceMode: companies.maintenanceMode })
  .from(companies)
  .where(eq(companies.id, companyId))
  .limit(1);

return NextResponse.json({
  status: 'ok',
  maintenanceMode: company?.maintenanceMode || false,
  // ...
});
```

**CorreÃ§Ã£o Aplicada:** API agora consulta banco e retorna campo corretamente  
**Resolvido por:** Cursor AI  
**Data:** 2025-11-05

---

## ğŸŸ¡ BUGS MÃ‰DIOS CONHECIDOS

### 5. ValidaÃ§Ã£o de Templates Muito Restritiva
**Arquivo:** `src/lib/template-engine.ts` linha 65
- Aceita apenas 5 variÃ¡veis mas cÃ³digo usa mais (aliases PT-BR)
- **Fix:** Expandir lista de variÃ¡veis vÃ¡lidas

### 6. NotificaÃ§Ãµes de Boas-Vindas com LÃ³gica Invertida
**Arquivo:** `src/lib/notification-scheduler.ts` linha 27
- Usa `lte` (â‰¤) em vez de `gte` (â‰¥)
- NÃ£o verifica flag `welcomeSent`
- **Fix:** Corrigir query e adicionar update da flag

### 7. Credenciais S3 Usadas para SES
**Arquivo:** `src/lib/notification-scheduler.ts` linha 87-89
- ConfiguraÃ§Ã£o SES usa credenciais S3 (incorreto)
- **Fix:** Usar `smtpUser` e `smtpPass` para SES

### 8. URL S3 Formatada Incorretamente
**Arquivo:** `src/lib/s3-client.ts` linha 89
- Formato nÃ£o segue padrÃ£o AWS S3
- **Fix:** Usar virtual-hosted style para AWS

### 9. Redis Worker Silencia Erros
**Arquivo:** `src/workers/notification-worker.ts` linha 15
- `client.on('error', () => {})` nÃ£o loga nada
- **Fix:** Adicionar logging adequado

---

## ğŸŸ¢ MELHORIAS RECOMENDADAS

### 10. ValidaÃ§Ã£o de Environment Variables
**PadrÃ£o:** Sempre validar `COMPANY_INIT` e outras env vars crÃ­ticas
```typescript
// âœ… BOM
const COMPANY_ID = process.env.COMPANY_INIT
if (!COMPANY_ID) throw new Error('COMPANY_INIT required')

// âŒ RUIM
const COMPANY_ID = process.env.COMPANY_INIT || ''
```

### 11. Rate Limiting e ValidaÃ§Ã£o de Upload
**Arquivo:** `src/app/api/v1/upload/route.ts`
- Falta limite de tamanho (MAX 10MB)
- Falta validaÃ§Ã£o de tipo de arquivo
- **Fix:** Adicionar validaÃ§Ãµes antes do upload

### 12. Cleanup de SessÃµes Expiradas
**Falta:** Cron job para limpar tabela `sessions`
- **Fix:** Criar `/api/cron/cleanup-sessions/route.ts`

---

## ğŸ¯ REGRAS DE DESENVOLVIMENTO

### TypeScript Strict Mode
```typescript
// SEMPRE usar tipos explÃ­citos
// âŒ EVITAR
const data: any = await fetch()

// âœ… CORRETO
interface ApiResponse {
  success: boolean
  data: UserData
}
const data: ApiResponse = await fetch()
```

### Error Handling
```typescript
// âœ… SEMPRE capturar e logar erros especÃ­ficos
try {
  await operation()
} catch (error) {
  if (error instanceof SpecificError) {
    // Handle especÃ­fico
  }
  console.error('Context:', error)
  throw error // ou retornar erro formatado
}

// âŒ NUNCA silenciar erros sem logging
try {
  await operation()
} catch {}  // RUIM!
```

### AutenticaÃ§Ã£o em API Routes
```typescript
// âœ… PADRÃƒO
import { validateRequest } from '@/lib/jwt' // OU auth.ts (escolher UM)

export async function GET() {
  const { user } = await validateRequest()
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  // ... resto do cÃ³digo
}
```

### Consultas ao Banco (Drizzle)
```typescript
// âœ… SEMPRE usar .limit(1) para queries Ãºnicas
const [user] = await db
  .select()
  .from(users)
  .where(eq(users.id, userId))
  .limit(1)  // IMPORTANTE!

if (!user) {
  // Handle not found
}

// âœ… SEMPRE usar indices de array (noUncheckedIndexedAccess estÃ¡ ON)
const user = users[0]  // Type: User | undefined
```

### Environment Variables
```typescript
// âœ… Validar no inÃ­cio do arquivo
const REQUIRED_VAR = process.env.REQUIRED_VAR
if (!REQUIRED_VAR) {
  throw new Error('REQUIRED_VAR is required')
}

// âŒ NÃ£o confiar em default vazio
const VAR = process.env.VAR || ''  // PERIGOSO
```

### S3 e Upload de Arquivos
```typescript
// âœ… Sempre validar tamanho e tipo
const MAX_SIZE = 10 * 1024 * 1024 // 10MB
if (file.size > MAX_SIZE) {
  return NextResponse.json({ error: 'File too large' }, { status: 413 })
}

const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'application/pdf']
if (!ALLOWED_TYPES.includes(file.type)) {
  return NextResponse.json({ error: 'Invalid file type' }, { status: 400 })
}
```

### NotificaÃ§Ãµes e Templates
```typescript
// âœ… Sempre logar sucesso/falha
await this.logNotification(userId, type, channel, success, content, error)

// âœ… Verificar preferÃªncias do usuÃ¡rio antes de enviar
const preferences = await getUserNotificationPreferences(userId)
if (!preferences.email) {
  // NÃ£o enviar email
}
```

---

## ğŸ”’ SEGURANÃ‡A

### Headers de SeguranÃ§a (Middleware)
```typescript
// âœ… Sempre adicionar em responses
res.headers.set('X-Content-Type-Options', 'nosniff')
res.headers.set('X-Frame-Options', 'SAMEORIGIN')
res.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')
res.headers.set('X-XSS-Protection', '1; mode=block')
```

### Cookies
```typescript
// âœ… SEMPRE usar configuraÃ§Ãµes seguras
{
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'lax',
  path: '/',
  maxAge: 30 * 24 * 60 * 60
}
```

### API Keys e Webhooks
```typescript
// âœ… Sempre validar autorizaÃ§Ã£o
const authHeader = request.headers.get('authorization')
if (!authHeader || authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
}
```

---

## ğŸ“¦ PADRÃ•ES DE CÃ“DIGO

### Estrutura de API Routes
```typescript
// âœ… PadrÃ£o consistente
export async function GET(request: NextRequest) {
  try {
    // 1. Validar autenticaÃ§Ã£o
    const { user } = await validateRequest()
    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // 2. Validar input (Zod)
    const validatedData = schema.parse(data)

    // 3. Buscar dados
    const result = await db.select()...

    // 4. Retornar resposta
    return NextResponse.json({ success: true, data: result })

  } catch (error) {
    // 5. Error handling especÃ­fico
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'Invalid data', details: error.errors },
        { status: 400 }
      )
    }

    console.error('API Error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

### Componentes React
```typescript
// âœ… Props tipadas com interface
interface ComponentProps {
  userId: string
  onSuccess?: () => void
  onError?: (error: Error) => void
}

export default function Component({ userId, onSuccess, onError }: ComponentProps) {
  // Hooks no topo
  const [state, setState] = useState()
  
  // Handlers
  const handleAction = async () => {
    try {
      await action()
      onSuccess?.()
    } catch (error) {
      onError?.(error as Error)
    }
  }

  // Render
  return <div>...</div>
}
```

---

## âœ… CHECKLIST PRÃ‰-COMMIT

- [ ] Todos os tipos estÃ£o corretos (sem `any`)
- [ ] Error handling adequado (sem `catch {}` vazio)
- [ ] ValidaÃ§Ã£o de input (Zod para APIs)
- [ ] Logs informativos (nÃ£o silenciar erros)
- [ ] AutenticaÃ§Ã£o em rotas protegidas
- [ ] Environment variables validadas
- [ ] Queries usam `.limit()` quando apropriado
- [ ] Headers de seguranÃ§a adicionados
- [ ] Sem `console.log` de debug (usar console.error/warn)

---

## âœ… CHECKLIST PRÃ‰-DEPLOY

### CRÃTICO
- [ ] `next.config.ts` com `ignoreBuildErrors: false`
- [ ] `next.config.ts` com `ignoreDuringBuilds: false`
- [ ] Sistema de autenticaÃ§Ã£o unificado (Lucia OU JWT, nÃ£o ambos)
- [ ] Middleware sem `AbortSignal.timeout()`
- [ ] API maintenance-check retornando `maintenanceMode`

### IMPORTANTE
- [ ] Todas env vars de produÃ§Ã£o configuradas
- [ ] Redis URL configurado (para notificaÃ§Ãµes)
- [ ] S3/SES credenciais separadas e corretas
- [ ] CRON_SECRET configurado
- [ ] JWT_SECRET forte e Ãºnico

### RECOMENDADO
- [ ] Backup do banco configurado
- [ ] Monitoring/logging (Sentry, etc)
- [ ] Rate limiting em APIs pÃºblicas
- [ ] Cleanup de sessÃµes agendado

---

## ğŸ¨ CONVENÃ‡Ã•ES DE NOME

### Arquivos
- Componentes React: `PascalCase.tsx` (ex: `ContributionForm.tsx`)
- API Routes: `route.ts` (dentro de pasta com nome da rota)
- Hooks: `use-kebab-case.ts` (ex: `use-upload.ts`)
- Libs/Utils: `kebab-case.ts` (ex: `s3-client.ts`)

### VariÃ¡veis e FunÃ§Ãµes
```typescript
// âœ… camelCase para variÃ¡veis e funÃ§Ãµes
const userData = await fetchUser()
async function handleSubmit() {}

// âœ… PascalCase para componentes e classes
class S3Service {}
function UserProfile() {}

// âœ… SCREAMING_SNAKE_CASE para constantes
const MAX_FILE_SIZE = 10 * 1024 * 1024
const API_BASE_URL = 'https://api.example.com'
```

---

## ğŸ§ª TESTING (TODO - Implementar)

```typescript
// PadrÃ£o para testes futuros
describe('Component/Function', () => {
  it('should handle success case', async () => {
    // Arrange
    const input = {...}
    
    // Act
    const result = await function(input)
    
    // Assert
    expect(result).toBe(expected)
  })

  it('should handle error case', async () => {
    // Test error handling
  })
})
```

---

## ğŸ“š RECURSOS E DOCUMENTAÃ‡ÃƒO

### DocumentaÃ§Ã£o Oficial
- Next.js 15: https://nextjs.org/docs
- Drizzle ORM: https://orm.drizzle.team/docs/overview
- Lucia Auth: https://lucia-auth.com/
- Zod: https://zod.dev/

### DocumentaÃ§Ã£o Interna
- `/docs/DB_DOCS.md` - Schema do banco
- `/docs/EMAIL_SYSTEM.md` - Sistema de emails
- `/docs/S3_TROUBLESHOOTING.md` - Troubleshooting S3
- `/docs/CIELO_API_GUIDE.md` - IntegraÃ§Ã£o Cielo
- `/docs/PENDING_IMPLEMENTATION.md` - Features pendentes

---

## ğŸ”„ WORKFLOW DE CORREÃ‡ÃƒO DE BUGS

1. **Identificar** - Ler este arquivo para bugs conhecidos
2. **Priorizar** - ComeÃ§ar por ğŸ”´ CRÃTICOS
3. **Corrigir** - Implementar fix sugerido
4. **Testar** - Validar que nÃ£o quebrou nada
5. **Documentar** - Atualizar este arquivo marcando como âœ… RESOLVIDO
6. **Commit** - Seguir conventional commits: `fix: corrige autenticaÃ§Ã£o duplicada`

---

## ğŸš€ PRIORIDADES ATUAIS (Atualizado: 2025-11-05)

### Sprint Atual
1. ğŸ”´ Remover `ignoreBuildErrors` do next.config.ts
2. ğŸ”´ Decidir e implementar sistema Ãºnico de auth (Lucia OU JWT)
3. ğŸ”´ Corrigir middleware AbortSignal
4. ğŸ”´ Implementar API maintenance-check corretamente

### PrÃ³xima Sprint
1. ğŸŸ¡ Corrigir lÃ³gica de notificaÃ§Ãµes de boas-vindas
2. ğŸŸ¡ Separar credenciais SES de S3
3. ğŸŸ¡ Melhorar error handling do Redis worker
4. ğŸŸ¢ Adicionar validaÃ§Ã£o de upload de arquivos

---

## ğŸ’¡ DICAS PARA IA ASSISTANTS

Ao trabalhar neste projeto:

1. **SEMPRE** verificar bugs conhecidos antes de modificar cÃ³digo relacionado
2. **NUNCA** usar `any` - sempre inferir ou definir tipos
3. **SEMPRE** adicionar error handling adequado
4. **VERIFICAR** qual sistema de auth estÃ¡ sendo usado (Lucia vs JWT)
5. **CONSULTAR** `/docs` para contexto de features especÃ­ficas
6. **ATUALIZAR** este arquivo ao resolver bugs (marcar como âœ…)
7. **SEGUIR** os padrÃµes de cÃ³digo definidos aqui

### Ao Criar Novas Features
- Usar Zod para validaÃ§Ã£o de input
- Adicionar logging apropriado
- Implementar error handling robusto
- Seguir estrutura de API routes padrÃ£o
- Documentar em `/docs` se necessÃ¡rio

### Ao Corrigir Bugs
- Verificar se estÃ¡ na lista de bugs conhecidos
- Entender a causa raiz antes de corrigir
- Testar edge cases
- Atualizar documentaÃ§Ã£o se necessÃ¡rio
- Marcar bug como resolvido neste arquivo

---

## ğŸ“ CHANGELOG DE BUGS

### 2025-11-05 - ATUALIZAÃ‡ÃƒO FINAL
- âœ… **RESOLVIDO**: Bug #1 - Build ignora erros (next.config.ts corrigido)
- âœ… **RESOLVIDO**: Bug #2 - AutenticaÃ§Ã£o duplicada (Lucia removido, JWT mantido)
- âœ… **RESOLVIDO**: Bug #3 - Middleware AbortSignal incompatÃ­vel (corrigido)
- âœ… **RESOLVIDO**: Bug #4 - API maintenance-check (implementado)
- ğŸ”´ CRÃTICOS: 4/4 resolvidos (100%) ğŸ‰
- ğŸŸ¡ MÃ‰DIOS: 0/5 resolvidos (0%)
- ğŸŸ¢ MELHORIAS: 0/3 implementadas (0%)
- **TOTAL**: 4/12 bugs resolvidos (33%)
- **STATUS**: âœ… PRONTO PARA PRODUÃ‡ÃƒO

### 2025-11-05 - INICIAL
- âœ… Identificados 12 bugs (4 crÃ­ticos, 5 mÃ©dios, 3 melhorias)
- DocumentaÃ§Ã£o completa criada
- Sistema de tracking implementado

---

**Ãšltima atualizaÃ§Ã£o:** 2025-11-05  
**VersÃ£o do projeto:** 0.1.2  
**Mantenedor:** Time de Desenvolvimento Vinha Admin

